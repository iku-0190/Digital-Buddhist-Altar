<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ãƒ‡ã‚¸ã‚¿ãƒ«ä»å£‡ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— vA10release</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,"æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“","YuGothic","ãƒ¡ã‚¤ãƒªã‚ª",sans-serif;
      background: radial-gradient(circle at top,#333 0,#000 55%);
      color: #f5f5f5;
      display: flex;
      justify-content: center;
    }
    .wrapper { max-width: 520px; width: 100%; min-height: 100vh; padding: 14px; }
    .app-card {
      background: rgba(15,15,15,.94);
      border-radius: 18px;
      padding: 14px 14px 16px;
      box-shadow: 0 0 25px rgba(0,0,0,.75);
      border: 1px solid #444;
    }
    .app-header { margin-bottom: 8px; }
    .app-title-main { font-size: 17px; font-weight: 600; }
    .app-title-sub { font-size: 11px; color: #ccc; margin-top: 2px; }

    .profile-switcher {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    .profile-switcher-label { font-size: 11px; color: #bbb; margin-right: 2px; }
    #profileChipContainer { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .profile-chip {
      border-radius: 999px;
      border: 1px solid #555;
      padding: 4px 10px;
      font-size: 11px;
      background: #111;
      color: #eee;
    }
    .profile-chip.active {
      background: linear-gradient(135deg,#9fd3ff,#3b81ff);
      border-color: #9fd3ff;
      color: #041424;
      font-weight: 600;
    }
    .profile-chip.add { border-style: dashed; opacity: .9; }
    .profile-count-label {
      font-size: 10px;
      color: #aaa;
    }
    .profile-delete-btn {
      margin-left: auto;
      padding-inline: 10px;
    }

    .reengage-banner {
      display: none;
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #66552a;
      background: #241c10;
      font-size: 11px;
      color: #f5e3c0;
    }
    .reengage-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .reengage-body {
      margin-bottom: 4px;
    }
    .reengage-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 3px;
    }
    .reengage-note {
      font-size: 10px;
      color: #c9bfa0;
    }

    .step-nav {
      display: flex;
      gap: 4px;
      margin: 10px 0 10px;
      overflow-x: auto;
    }
    .step-nav button {
      flex: 1; min-width: 0;
      border-radius: 999px;
      border: 1px solid #555;
      padding: 6px 8px;
      font-size: 11px;
      background: #111;
      color: #eee;
      white-space: nowrap;
    }
    .step-nav button.active {
      background: linear-gradient(135deg,#f5d27a,#b58b2a);
      border-color: #f5d27a;
      color: #16130a;
      font-weight: 600;
    }

    .divider {
      height: 1px;
      margin: 8px 0 10px;
      background: linear-gradient(to right,transparent,#777,transparent);
    }
    .section-title {
      font-size: 13px;
      letter-spacing: .08em;
      color: #bbb;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .portrait-area { display: flex; gap: 10px; align-items: center; }
    .portrait-frame {
      flex: 0 0 110px;
      padding: 6px;
      border-radius: 12px;
      border: 3px solid #f5f5f5;
      background: linear-gradient(135deg,#444,#111);
    }
    .portrait {
      height: 128px;
      border-radius: 8px;
      background: #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #eee;
      text-align: center;
      padding: 4px;
    }
    .portrait-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      margin-bottom: 4px;
    }
    .portrait-status-pill span { font-weight: 600; }
    .portrait-status-pill.status-unsubmitted {
      background: rgba(120,120,120,.15);
      border: 1px solid #666;
      color: #ddd;
    }
    .portrait-status-pill.status-review {
      background: rgba(255,196,87,.12);
      border: 1px solid #f5d27a;
      color: #f5d27a;
    }
    .portrait-status-pill.status-approved {
      background: rgba(126,217,109,.15);
      border: 1px solid #7ed96d;
      color: #caffb8;
    }
    .portrait-text { font-size: 12px; color: #e0e0e0; line-height: 1.5; }
    .portrait-buttons { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 6px; }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 11px;
      border: 1px solid #666;
      background: #171717;
      color: #f8f8f8;
    }
    .btn-primary {
      border-color: #f5d27a;
      background: linear-gradient(135deg,#f5d27a,#b58b2a);
      color: #16130a;
      font-weight: 600;
    }
    .btn-ghost { background: transparent; }
    .btn-small { padding: 4px 9px; font-size: 11px; }
    .btn:active { opacity: .85; }
    .note { font-size: 10px; color: #999; margin-top: 6px; line-height: 1.5; }

    
    .ihai-preview-card {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #555;
      background: #151515;
      font-size: 11px;
      line-height: 1.5;
    }
    .ihai-preview-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
    }
    .ihai-preview-text {
      font-size: 11px;
      color: #f5e3c0;
    }

    .altar-layout { display: flex; flex-direction: column; gap: 10px; }
    .altar-preview {
      border-radius: 14px;
      padding: 10px;
      border: 1px solid #555;
      background: radial-gradient(circle at top,#3a2a18 0,#120e0a 55%);
      min-height: 150px;
      position: relative;
      overflow: hidden;
    }
    .altar-preview.alt-basic { background: radial-gradient(circle at top,#3a2a18 0,#120e0a 55%); }
    .altar-preview.alt-gold { background: radial-gradient(circle at top,#614000 0,#1b1205 55%); }
    .altar-preview.alt-modern { background: radial-gradient(circle at top,#3c4148 0,#0b0d10 55%); }

    .altar-shelf {
      position: absolute;
      left: 6%; right: 6%; bottom: 18%; height: 32%;
      border-radius: 10px 10px 4px 4px;
      background: linear-gradient(to bottom,rgba(0,0,0,.2),rgba(0,0,0,.7));
      border-top: 1px solid rgba(255,255,255,.2);
    }
    .altar-base {
      position: absolute;
      left: 0; right: 0; bottom: 9%; height: 16%;
      background: linear-gradient(to bottom,rgba(0,0,0,.1),rgba(0,0,0,.9));
    }
    .altar-portrait-small {
      position: absolute;
      top: 16%; left: 50%;
      transform: translateX(-50%);
      width: 80px; height: 95px;
      border-radius: 9px;
      background: rgba(120,120,120,.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      text-align: center;
      padding: 3px;
      border: 2px solid rgba(245,245,245,.7);
    }
    .altar-portrait-small.approved { background: rgba(230,230,230,.95); color: #222; }
    .altar-label {
      position: absolute;
      top: 6%; left: 10px;
      font-size: 11px;
      color: #f5e3c0;
      text-shadow: 0 0 4px rgba(0,0,0,.6);
    }
    .altar-status {
      position: absolute;
      top: 6%; right: 10px;
      font-size: 11px;
      color: #eee;
      background: rgba(0,0,0,.45);
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.15);
    }
    .altar-items-row {
      position: absolute;
      bottom: 22%; left: 8%; right: 8%;
      display: flex;
      justify-content: center;
      gap: 12px;
      font-size: 11px;
    }

    .altar-ihai {
      position: absolute;
      bottom: 24%;
      left: 18%;
      width: 60px;
      padding: 4px 2px;
      border-radius: 4px 4px 2px 2px;
      background: linear-gradient(to bottom,#3b2a1a,#1c140d);
      border: 1px solid rgba(255,255,255,.2);
      font-size: 9px;
      color: #f8f0dc;
      text-align: center;
      line-height: 1.4;
      box-shadow: 0 0 4px rgba(0,0,0,.7);
      z-index: 3;
      display: none;
      writing-mode: vertical-rl;
      text-orientation: mixed;
    }

    .altar-draggable {
      touch-action: none;
      cursor: grab;
    }

    .altar-rin {
      position: absolute;
      bottom: 19%;
      right: 20%;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #dddddd 0,#b0b0b0 40%,#555555 100%);
      box-shadow: 0 0 4px rgba(0,0,0,.7);
      z-index: 3;
    }

    .altar-rin-stick {
      position: absolute;
      bottom: 17%;
      right: 10%;
      width: 22px;
      height: 7px;
      border-radius: 3px;
      background: linear-gradient(to right,#d9c28a,#a27c43);
      box-shadow: 0 0 3px rgba(0,0,0,.6);
      z-index: 3;
    }
    .altar-item-pill {
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(0,0,0,.5);
      border: 1px solid rgba(255,255,255,.18);
    }

    .incense-area {
      position: absolute;
      bottom: 20%;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 40px;
      pointer-events: auto;
      opacity: 0;
      transition: opacity .3s ease;
    }
    .incense-area.active { opacity: 1; }
    .incense-burner {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 12px;
      border-radius: 8px;
      background: radial-gradient(circle at top,#555 0,#222 60%);
      box-shadow: 0 0 6px rgba(0,0,0,.7);
      border: 1px solid rgba(255,255,255,.2);
    }
    .incense-stick {
      position: absolute;
      bottom: 10px;
      left: 50%;
      width: 3px;
      height: 16px;
      transform: translateX(-50%);
      background: linear-gradient(to top,#4a2a1a,#d7c08a);
      border-radius: 2px;
    }
    .incense-smoke {
      position: absolute;
      bottom: 26px;
      left: 50%;
      width: 6px;
      height: 16px;
      border-radius: 50%;
      background: radial-gradient(circle,rgba(255,255,255,.9) 0,rgba(255,255,255,0) 70%);
      opacity: 0;
      transform: translateX(-50%);
      animation: smokeRise 2.6s linear infinite;
    }
    .incense-smoke.smoke-2 { animation-delay: .9s; }
    .incense-smoke.smoke-3 { animation-delay: 1.8s; }
    @keyframes smokeRise {
      0% { opacity: 0; transform: translate(-50%,0) scale(.6); }
      30% { opacity: .8; transform: translate(-50%,-6px) scale(.9); }
      70% { opacity: .4; transform: translate(-50%,-14px) scale(1.1); }
      100% { opacity: 0; transform: translate(-50%,-22px) scale(1.2); }
    }

    .altar-controls {
      border-radius: 12px;
      border: 1px solid #333;
      background: #151515;
      padding: 8px;
      font-size: 12px;
    }
    .form-row { display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; }
    .form-row label { font-size: 11px; color: #ccc; }
    select,input[type=text],textarea,input[type=date] {
      border-radius: 999px;
      border: 1px solid #555;
      background: #101010;
      color: #f5f5f5;
      font-size: 12px;
      padding: 6px 9px;
      flex: 1;
      min-width: 0;
    }
    textarea { border-radius: 10px; resize: vertical; min-height: 48px; }

    .quick-offerings {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
      margin: 2px 0 4px;
      font-size: 10px;
      color: #bbb;
    }
    .quick-offerings-label {
      margin-right: 2px;
    }

    .catalog-list {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      margin-top: 4px;
      padding-bottom: 2px;
    }
    .catalog-card {
      flex: 0 0 160px;
      border-radius: 10px;
      border: 1px solid #444;
      padding: 6px;
      background: #1b1b1b;
      font-size: 11px;
    }
    .catalog-name { font-weight: 600; margin-bottom: 2px; }
    .catalog-meta { font-size: 10px; color: #b5b5b5; margin-bottom: 2px; }

    .offering-history {
      margin-top: 6px;
      font-size: 11px;
      color: #ccc;
    }
    .offering-history-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
    }
    .offering-history-list {
      font-size: 11px;
      color: #aaa;
    }

    .ritual-controls {
      margin-top: 6px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid #333;
      background: #141414;
      font-size: 11px;
    }
    .ritual-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 6px; align-items: center; }
    .ritual-label { font-size: 11px; color: #ccc; min-width: 70px; }
    .ritual-status-text { font-size: 11px; color: #f5d27a; }

    .profile-summary {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid #333;
      background: #171717;
      font-size: 12px;
      line-height: 1.6;
    }
    .profile-summary-title { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
    .profile-summary-sub { font-size: 11px; color: #bbb; }
    .profile-form-grid { display: flex; flex-direction: column; gap: 6px; margin-top: 4px; }
    .profile-form-grid label { font-size: 11px; color: #ccc; display: block; margin-bottom: 2px; }
    .profile-save-row { margin-top: 6px; display: flex; justify-content: flex-end; gap: 8px; align-items: center; }
    .save-status { font-size: 10px; color: #9fd69f; }

    .danger-zone {
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #553;
      background: #1b1414;
      font-size: 11px;
      color: #f5d5d5;
    }
    .danger-zone-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
    }

    .audio-grid { display: flex; flex-direction: column; gap: 8px; }
    .audio-card {
      border-radius: 10px;
      border: 1px solid #333;
      background: #171717;
      padding: 8px;
      font-size: 12px;
    }
    .audio-phrase { font-weight: 600; margin-bottom: 2px; }
    .audio-note { font-size: 11px; color: #aaa; margin-top: 4px; }

    .shukatsu-grid { display: flex; flex-direction: column; gap: 8px; }
    .shukatsu-card {
      border-radius: 10px;
      border: 1px solid #333;
      background: #181818;
      padding: 8px;
      font-size: 12px;
    }
    .shukatsu-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .shukatsu-sub {
      font-size: 11px;
      color: #bbb;
      margin-bottom: 4px;
    }
    .shukatsu-save-row {
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
    }
    .shukatsu-save-status {
      font-size: 10px;
      color: #9fd69f;
    }

    .footer {
      margin-top: 10px;
      font-size: 11px;
      color: #888;
      text-align: center;
      line-height: 1.6;
    }
    .badge {
      display: inline-block;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #666;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="app-card">
      <div class="app-header">
        <div class="app-title-main">ãƒ‡ã‚¸ã‚¿ãƒ«ä»å£‡ã‚¢ãƒ—ãƒªãƒ»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</div>
        <div class="app-title-sub">â‘ éºå½± â†’ â‘¡ä»å£‡ï¼‹ãŠä¾›ãˆ â†’ â‘¢ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« â†’ â‘£éŸ³å£° â†’ â‘¤çµ‚æ´»ãƒ¡ãƒ¢</div>
        <div class="profile-switcher">
          <span class="profile-switcher-label">ã”ä¾›é¤Šã™ã‚‹æ–¹ï¼š</span>
          <div id="profileChipContainer"></div>
          <span id="profileCountLabel" class="profile-count-label">ï¼ˆç™»éŒ²ãªã—ï¼‰</span>
          <button id="btnDeleteProfile" type="button" class="btn btn-ghost btn-small profile-delete-btn" style="display:none;">
            ã“ã®æ–¹ã‚’å‰Šé™¤
          </button>
        </div>
      </div>

      <div id="reengageBanner" class="reengage-banner">
        <div id="reengageTitle" class="reengage-title">å¤§åˆ‡ãªæ–¹ãŒå‘¼ã‚“ã§ã„ã¾ã™ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</div>
        <div id="reengageBody" class="reengage-body">
          å‰å›ã®ã”åˆ©ç”¨ã‹ã‚‰å°‘ã—æ™‚é–“ãŒç©ºãã¾ã—ãŸã€‚å¤§åˆ‡ãªæ–¹ãŒã€ã‚ãªãŸã«ä¼šã„ãŸãŒã£ã¦ã„ã¾ã™ã€‚
        </div>
        <div class="reengage-actions">
          <span id="reengageStatus" class="shukatsu-save-status"></span>
          <button id="btnReengageVoice" type="button" class="btn btn-small">ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’èãï¼ˆãƒ‡ãƒ¢ï¼‰</button>
        </div>
        <div class="reengage-note">
          â€»æœ¬ç•ªã‚¢ãƒ—ãƒªã§ã¯ã€é€šçŸ¥ãƒãƒƒã‚¸ã‚„æ•…äººã®å£°ã®å†ç”Ÿã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®HTMLãƒ‡ãƒ¢ã§ã¯ã€ç°¡æ˜“ãªåŠ¹æœéŸ³ã®ã¿ã‚’é³´ã‚‰ã—ã¾ã™ã€‚
        </div>
      </div>

      <div class="step-nav">
        <button class="active" data-tab="portrait">â‘  éºå½±ãƒ»ä½ç‰Œ</button>
        <button data-tab="altar">â‘¡ ä»å£‡ãƒ»ãŠä¾›ãˆ</button>
        <button data-tab="profile">â‘¢ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
        <button data-tab="audio">â‘£ éŸ³å£°ï¼ˆå°†æ¥æ¡ˆï¼‰</button>
        <button data-tab="shukatsu">â‘¤ çµ‚æ´»ãƒ¡ãƒ¢</button>
      </div>

      <div class="divider"></div>

      <!-- Portrait Tab -->
      <section id="tab-portrait" class="tab-panel active">
        <div class="section-title">Portrait &amp; Ihai</div>
        <div class="portrait-area">
          <div class="portrait-frame">
            <div id="portraitDisplay" class="portrait">
              éºå½±ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰<br>ã‚¿ãƒƒãƒ—ã§å¤‰æ›´ã¯<br>ã‚¢ãƒ—ãƒªç‰ˆã§å®Ÿè£…äºˆå®š
            </div>
          </div>
          <div style="flex:1;">
            <div id="portraitStatusPill" class="portrait-status-pill status-unsubmitted">
              <span>æœªç”³è«‹</span>ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
            </div>
            <div class="portrait-text" id="portraitStatusText">
              ã”å®¶æ—ãƒ»èº«è¿‘ãªæ–¹ã®éºå½±ã¯ã€å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã”è‡ªèº«ã®ç«¯æœ«ã‹ã‚‰ç›´æ¥è¨­å®šã§ãã‚‹æƒ³å®šã§ã™ï¼ˆç”³è«‹ä¸è¦ï¼‰ã§ã™ã€‚<br>
              æœ‰åäººã¨ã®å…¬å¼ã‚³ãƒ©ãƒœéºå½±ãƒ—ãƒ©ãƒ³ã§ã¯ã€é‹å–¶å´ãŒç”¨æ„ã—ãŸå…¬å¼å†™çœŸã®ã¿ã‚’åˆ©ç”¨ã—ã€ã‚¹ã‚¿ãƒƒãƒ•ãŒç¢ºèªã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
              ã“ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§ã€Œç”³è«‹ä¸­ï¼æ‰¿èªæ¸ˆã¿ã€ã®æµã‚Œã ã‘ã‚’ä½“é¨“ã§ãã¾ã™ï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯ã¾ã è¡Œã„ã¾ã›ã‚“ï¼‰ã€‚
            </div>
            <div class="portrait-buttons">
              <button id="btnRequestPortrait" class="btn-primary" type="button">éºå½±ã‚’ç”³è«‹ã—ãŸã“ã¨ã«ã™ã‚‹ï¼ˆãƒ‡ãƒ¢ï¼‰</button>
              <button id="btnApprovePortrait" class="btn btn-ghost" type="button">å¯©æŸ»ã§ã€Œæ‰¿èªã€ã«ãªã£ãŸã“ã¨ã«ã™ã‚‹ï¼ˆãƒ‡ãƒ¢ï¼‰</button>
            </div>
            <div class="note">
              â€»ç”»é¢ä¸Šéƒ¨ã®ã€Œï¼‹è¿½åŠ ã€ã§å…¥åŠ›ã—ãŸã€Œç¥–çˆ¶ã€ã€Œç¥–æ¯ã€ã€Œãƒšãƒƒãƒˆã€ãªã©ã®ãƒ©ãƒ™ãƒ«ãŒã€<br>
              ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§ãŠåå‰æœªå…¥åŠ›ã®å ´åˆã®ä»å£‡ã®éºå½±ã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚<br>
              ï¼ˆãŠåå‰ã‚’å…¥åŠ›ã—ãŸå ´åˆã¯ã€ãã®ãŠåå‰ãŒå„ªå…ˆã•ã‚Œã¾ã™ï¼‰
            </div>

            <div class="ihai-preview-card">
              <div class="ihai-preview-title">ä½ç‰Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</div>
              <div id="ihaiPreviewText" class="ihai-preview-text">
                ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ãƒ–ã§ã€Œæˆ’åã€ã¾ãŸã¯ãŠåå‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«ä½ç‰Œã®æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </div>
              <div class="note">
                â€»æœ¬ç•ªã‚¢ãƒ—ãƒªã§ã¯ã€å®Ÿéš›ã®ä½ç‰Œãƒ‡ã‚¶ã‚¤ãƒ³ã«ã‚ã‚ã›ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¡¨ç¤ºã™ã‚‹æƒ³å®šã§ã™ã€‚
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Altar Tab -->
      <section id="tab-altar" class="tab-panel">
        <div class="section-title">Altar</div>
        <div class="altar-layout">
          <div class="altar-preview alt-basic" id="altarPreview">
            <div class="altar-label" id="altarLabel">ã‚·ãƒ³ãƒ—ãƒ«ãªä»å£‡ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</div>
            <div class="altar-status" id="altarPortraitStatus">éºå½±ï¼šæœªæ‰¿èª</div>
            <div class="altar-portrait-small" id="altarPortraitSmall">éºå½±ç¢ºèªä¸­</div>
            <div class="altar-items-row" id="altarItemsRow">
              <div class="altar-item-pill">ğŸ•¯ ãŠç·šé¦™</div>
              <div class="altar-item-pill">ğŸ’ ãŠèŠ±</div>
            </div>
            <div class="altar-ihai altar-draggable" id="altarIhai"></div>
            <div class="altar-rin altar-draggable" id="altarRin"></div>
            <div class="altar-rin-stick altar-draggable" id="altarRinStick"></div>
            <div class="incense-area altar-draggable" id="incenseArea">
              <div class="incense-burner"></div>
              <div class="incense-stick"></div>
              <div class="incense-smoke smoke-1"></div>
              <div class="incense-smoke smoke-2"></div>
              <div class="incense-smoke smoke-3"></div>
            </div>
            <div class="altar-shelf"></div>
            <div class="altar-base"></div>
          </div>

          <div class="altar-controls">
            <div class="form-row">
              <label for="altarStyleSelect">ä»å£‡ã®ã‚¿ã‚¤ãƒ—</label>
              <select id="altarStyleSelect">
                <option value="basic">ã‚·ãƒ³ãƒ—ãƒ«ä»å£‡ï¼ˆæ¨™æº–ï¼‰</option>
                <option value="gold">é‡‘ä»å£‡ï¼ˆè˜å³ï¼‰</option>
                <option value="modern">ãƒ¢ãƒ€ãƒ³ä»å£‡ï¼ˆãƒªãƒ“ãƒ³ã‚°å‘ã‘ï¼‰</option>
              </select>
            </div>
            <div class="form-row">
              <label for="altarItemsInput">ãŠä¾›ãˆã™ã‚‹ã‚‚ã®ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
              <input id="altarItemsInput" type="text" placeholder="ä¾‹ï¼‰ãŠç·šé¦™, ãŠèŠ±, ãƒ“ãƒ¼ãƒ«, å’Œè“å­">
            </div>
            <div class="quick-offerings">
              <span class="quick-offerings-label">ã‚ˆãä½¿ã†ãŠä¾›ãˆï¼š</span>
              <button type="button" class="btn btn-small quick-offering" data-offering="ãŠç·šé¦™">ãŠç·šé¦™</button>
              <button type="button" class="btn btn-small quick-offering" data-offering="ãŠèŠ±">ãŠèŠ±</button>
              <button type="button" class="btn btn-small quick-offering" data-offering="å’Œè“å­">å’Œè“å­</button>
              <button type="button" class="btn btn-small quick-offering" data-offering="ã‚³ãƒ¼ãƒ’ãƒ¼">ã‚³ãƒ¼ãƒ’ãƒ¼</button>
              <button type="button" class="btn btn-small quick-offering" data-offering="ãƒ“ãƒ¼ãƒ«">ãƒ“ãƒ¼ãƒ«</button>
            </div>
            <div class="form-row" style="justify-content:flex-end;">
              <button id="btnApplyAltar" type="button" class="btn btn-primary">ä»å£‡ã«åæ˜ ã™ã‚‹ï¼ˆã“ã®æ–¹ã®è¨­å®šï¼‰</button>
            </div>
            <div class="note">
              â€»å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ã“ã®ä¸‹ã«ã€ŒãŠä¾›ãˆã‚«ã‚¿ãƒ­ã‚°ã€ã‹ã‚‰å•†å“ã‚’é¸ã³ã€<br>
              ã€Œãƒ‡ã‚¸ã‚¿ãƒ«ã§ãŠä¾›ãˆã€ã¾ãŸã¯ã€Œå®Ÿç‰©ã‚’æ³¨æ–‡ã€ã‚’é¸ã¶ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
            </div>

            <!-- ä»å£‡ã‚«ã‚¿ãƒ­ã‚°ï¼ˆæ—¢å­˜ã®ä»å£‡ã‚¿ã‚¤ãƒ—é¸æŠï¼‰ -->
            <div style="margin-top:6px;">
              <div style="font-size:11px;color:#bbb;margin-bottom:2px;">ä»å£‡ã‚«ã‚¿ãƒ­ã‚°ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</div>
              <div class="catalog-list">
                <div class="catalog-card" data-style="basic">
                  <div class="catalog-name">ã‚·ãƒ³ãƒ—ãƒ«ä»å£‡</div>
                  <div class="catalog-meta">æœ¨ç›®èª¿ãƒ»çœã‚¹ãƒšãƒ¼ã‚¹ãƒ»ä¸€äººæš®ã‚‰ã—ã«ã‚‚</div>
                  <button type="button" class="btn btn-ghost btn-small btn-catalog-choose">ã“ã‚Œã‚’é¸ã¶</button>
                </div>
                <div class="catalog-card" data-style="gold">
                  <div class="catalog-name">é‡‘ä»å£‡</div>
                  <div class="catalog-meta">ä¼çµ±çš„ãƒ»ã”æœ¬å°Šã¨ä½ç‰Œã‚’ç¥€ã‚‹æœ¬æ ¼ã‚¿ã‚¤ãƒ—</div>
                  <button type="button" class="btn btn-ghost btn-small btn-catalog-choose">ã“ã‚Œã‚’é¸ã¶</button>
                </div>
                <div class="catalog-card" data-style="modern">
                  <div class="catalog-name">ãƒ¢ãƒ€ãƒ³ä»å£‡</div>
                  <div class="catalog-meta">ãƒªãƒ“ãƒ³ã‚°ã«é¦´æŸ“ã‚€ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»æ‰‰ä»˜ã</div>
                  <button type="button" class="btn btn-ghost btn-small btn-catalog-choose">ã“ã‚Œã‚’é¸ã¶</button>
                </div>
              </div>
            </div>

            <!-- ãŠä¾›ãˆã‚«ã‚¿ãƒ­ã‚°ï¼ˆå®Ÿåœ¨å•†å“ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ -->
            <div style="margin-top:10px;">
              <div style="font-size:11px;color:#bbb;margin-bottom:2px;">ãŠä¾›ãˆã‚«ã‚¿ãƒ­ã‚°ï¼ˆå®Ÿåœ¨å•†å“ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</div>
              <div class="catalog-list">
                <!-- ãƒ“ãƒ¼ãƒ« -->
                <div class="catalog-card">
                  <div class="catalog-name">ã‚µãƒ³ãƒ—ãƒ«ãƒ“ãƒ¼ãƒ«Aï¼ˆç¼¶350mlï¼‰</div>
                  <div class="catalog-meta">ãƒ“ãƒ¼ãƒ«ä¼šç¤¾ã¨ã®ã‚³ãƒ©ãƒœæƒ³å®š</div>
                  <div class="catalog-meta">ã‚«ãƒ†ã‚´ãƒªï¼šãƒ“ãƒ¼ãƒ«</div>
                  <button type="button" class="btn btn-small btn-offer-digital" data-offering="ã‚µãƒ³ãƒ—ãƒ«ãƒ“ãƒ¼ãƒ«Aï¼ˆç¼¶ï¼‰">ãƒ‡ã‚¸ã‚¿ãƒ«ã§ãŠä¾›ãˆ</button>
                  <button type="button" class="btn btn-small btn-offer-buy">å®Ÿç‰©ã‚’æ³¨æ–‡ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</button>
                </div>
                <div class="catalog-card">
                  <div class="catalog-name">ã‚µãƒ³ãƒ—ãƒ«ãƒ“ãƒ¼ãƒ«Bï¼ˆç“¶ï¼‰</div>
                  <div class="catalog-meta">ãƒ“ãƒ¼ãƒ«ä¼šç¤¾ã¨ã®ã‚³ãƒ©ãƒœæƒ³å®š</div>
                  <div class="catalog-meta">ã‚«ãƒ†ã‚´ãƒªï¼šãƒ“ãƒ¼ãƒ«</div>
                  <button type="button" class="btn btn-small btn-offer-digital" data-offering="ã‚µãƒ³ãƒ—ãƒ«ãƒ“ãƒ¼ãƒ«Bï¼ˆç“¶ï¼‰">ãƒ‡ã‚¸ã‚¿ãƒ«ã§ãŠä¾›ãˆ</button>
                  <button type="button" class="btn btn-small btn-offer-buy">å®Ÿç‰©ã‚’æ³¨æ–‡ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</button>
                </div>

                <!-- å’Œè“å­ -->
                <div class="catalog-card">
                  <div class="catalog-name">ä¸Šå“ãªå’Œè“å­è©°ã‚åˆã‚ã›</div>
                  <div class="catalog-meta">è“å­ãƒ¡ãƒ¼ã‚«ãƒ¼ã¨ã®ã‚³ãƒ©ãƒœæƒ³å®š</div>
                  <div class="catalog-meta">ã‚«ãƒ†ã‚´ãƒªï¼šå’Œè“å­</div>
                  <button type="button" class="btn btn-small btn-offer-digital" data-offering="å’Œè“å­è©°ã‚åˆã‚ã›">ãƒ‡ã‚¸ã‚¿ãƒ«ã§ãŠä¾›ãˆ</button>
                  <button type="button" class="btn btn-small btn-offer-buy">å®Ÿç‰©ã‚’æ³¨æ–‡ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</button>
                </div>

                <!-- ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ»ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯ -->
                <div class="catalog-card">
                  <div class="catalog-name">é¦™ã‚Šè±Šã‹ãªãƒ‰ãƒªãƒƒãƒ—ã‚³ãƒ¼ãƒ’ãƒ¼</div>
                  <div class="catalog-meta">ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ–ãƒ©ãƒ³ãƒ‰ã¨ã®ã‚³ãƒ©ãƒœæƒ³å®š</div>
                  <div class="catalog-meta">ã‚«ãƒ†ã‚´ãƒªï¼šã‚³ãƒ¼ãƒ’ãƒ¼</div>
                  <button type="button" class="btn btn-small btn-offer-digital" data-offering="ãƒ‰ãƒªãƒƒãƒ—ã‚³ãƒ¼ãƒ’ãƒ¼">ãƒ‡ã‚¸ã‚¿ãƒ«ã§ãŠä¾›ãˆ</button>
                  <button type="button" class="btn btn-small btn-offer-buy">å®Ÿç‰©ã‚’æ³¨æ–‡ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</button>
                </div>
                <div class="catalog-card">
                  <div class="catalog-name">ãƒšãƒƒãƒˆãƒœãƒˆãƒ«ç·‘èŒ¶</div>
                  <div class="catalog-meta">æ¸…æ¶¼é£²æ–™ãƒ¡ãƒ¼ã‚«ãƒ¼ã¨ã®ã‚³ãƒ©ãƒœæƒ³å®š</div>
                  <div class="catalog-meta">ã‚«ãƒ†ã‚´ãƒªï¼šã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯</div>
                  <button type="button" class="btn btn-small btn-offer-digital" data-offering="ãƒšãƒƒãƒˆãƒœãƒˆãƒ«ç·‘èŒ¶">ãƒ‡ã‚¸ã‚¿ãƒ«ã§ãŠä¾›ãˆ</button>
                  <button type="button" class="btn btn-small btn-offer-buy">å®Ÿç‰©ã‚’æ³¨æ–‡ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</button>
                </div>

                <!-- æ—¥æœ¬é…’ãƒ»é…’é€ ãƒ¡ãƒ¼ã‚«ãƒ¼ -->
                <div class="catalog-card">
                  <div class="catalog-name">ç‰¹åˆ¥ç´”ç±³é…’ã‚µãƒ³ãƒ—ãƒ«</div>
                  <div class="catalog-meta">é…’é€ ãƒ¡ãƒ¼ã‚«ãƒ¼ã¨ã®ã‚³ãƒ©ãƒœæƒ³å®š</div>
                  <div class="catalog-meta">ã‚«ãƒ†ã‚´ãƒªï¼šæ—¥æœ¬é…’</div>
                  <button type="button" class="btn btn-small btn-offer-digital" data-offering="ç‰¹åˆ¥ç´”ç±³é…’ã‚µãƒ³ãƒ—ãƒ«">ãƒ‡ã‚¸ã‚¿ãƒ«ã§ãŠä¾›ãˆ</button>
                  <button type="button" class="btn btn-small btn-offer-buy">å®Ÿç‰©ã‚’æ³¨æ–‡ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</button>
                </div>

                <!-- ã‚«ãƒƒãƒ—éºº -->
                <div class="catalog-card">
                  <div class="catalog-name">ã‚«ãƒƒãƒ—éººãƒ»ã—ã‚‡ã†ã‚†å‘³</div>
                  <div class="catalog-meta">ã‚«ãƒƒãƒ—éººãƒ¡ãƒ¼ã‚«ãƒ¼ã¨ã®ã‚³ãƒ©ãƒœæƒ³å®š</div>
                  <div class="catalog-meta">ã‚«ãƒ†ã‚´ãƒªï¼šã‚«ãƒƒãƒ—éºº</div>
                  <button type="button" class="btn btn-small btn-offer-digital" data-offering="ã‚«ãƒƒãƒ—éººï¼ˆã—ã‚‡ã†ã‚†ï¼‰">ãƒ‡ã‚¸ã‚¿ãƒ«ã§ãŠä¾›ãˆ</button>
                  <button type="button" class="btn btn-small btn-offer-buy">å®Ÿç‰©ã‚’æ³¨æ–‡ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰</button>
                </div>
              </div>
              <div class="note">
                â€»ã“ã“ã§ã¯å…¨ã¦ã€Œã‚µãƒ³ãƒ—ãƒ«å•†å“ã€ã§ã™ã€‚å°†æ¥çš„ã«ã¯ã€ãƒ“ãƒ¼ãƒ«ä¼šç¤¾ãƒ»é…’é€ ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»è“å­ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»ã‚«ãƒƒãƒ—éººãƒ¡ãƒ¼ã‚«ãƒ¼ç­‰ã¨æ­£å¼ã‚³ãƒ©ãƒœã—ã€<br>
                å®Ÿåœ¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒŸãƒ‹ãƒãƒ¥ã‚¢è¡¨ç¤ºï¼‹ECã‚µã‚¤ãƒˆé€£æºã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
              </div>
            </div>

            <div style="margin-top:8px;">
              <div style="font-size:11px;color:#bbb;margin-bottom:2px;">ä»å…·ã®è¡¨ç¤ºãƒ»ä½ç½®ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•ã§ãã¾ã™ï¼‰</div>
              <div style="font-size:11px;color:#aaa;margin-bottom:4px;">
                ä»å£‡å†…ã®ã€ŒãŠã‚Šã‚“ãƒ»ã‚Šã‚“æ£’ãƒ»é¦™ç‚‰ãƒ»ä½ç‰Œã€ã¯ã€æŒ‡ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®ã‚’å‹•ã‹ã›ã¾ã™ã€‚<br>
                ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã§è¡¨ç¤ºï¼éè¡¨ç¤ºã‚‚åˆ‡ã‚Šæ›¿ãˆã§ãã¾ã™ï¼ˆã“ã®ç«¯æœ«å†…ã®ã¿ï¼‰ã€‚
              </div>
              <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:11px;">
                <label><input type="checkbox" id="toggleIhai" checked> ä½ç‰Œã‚’è¡¨ç¤º</label>
                <label><input type="checkbox" id="toggleIncense" checked> é¦™ç‚‰ï¼‹ç·šé¦™ã‚’è¡¨ç¤º</label>
                <label><input type="checkbox" id="toggleRin" checked> ãŠã‚Šã‚“ã‚’è¡¨ç¤º</label>
                <label><input type="checkbox" id="toggleRinStick" checked> ã‚Šã‚“æ£’ã‚’è¡¨ç¤º</label>
              </div>
            </div>

            <div class="offering-history" id="offeringHistory">
              <div class="offering-history-title">æœ€è¿‘ã“ã®æ–¹ã«ãŠä¾›ãˆã—ãŸã‚‚ã®ï¼ˆã“ã®ç«¯æœ«å†…ï¼‰</div>
              <div class="offering-history-list" id="offeringHistoryList">ã¾ã è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
            </div>
          </div>

          <div class="ritual-controls">
            <div class="ritual-row">
              <span class="ritual-label">éˆ´ï¼š</span>
              <button id="btnRingBell" type="button" class="btn btn-small">éˆ´ã‚’é³´ã‚‰ã™ï¼ˆãƒãƒ¼ãƒ³ï¼‰</button>
              <span id="bellStatus" class="ritual-status-text"></span>
            </div>
            <div class="ritual-row">
              <span class="ritual-label">ç·šé¦™ï¼š</span>
              <button type="button" class="btn btn-small" data-incense="15">15ç§’</button>
              <button type="button" class="btn btn-small" data-incense="30">30ç§’</button>
              <button type="button" class="btn btn-small" data-incense="60">1åˆ†</button>
              <span id="incenseStatus" class="ritual-status-text"></span>
            </div>
            <div class="note">
              â€»ã“ã®ãƒ‡ãƒ¢ã§ã¯ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¨é¦™ç‚‰ã®ç…™ã®è¡¨ç¤ºã®ã¿è¡Œã„ã¾ã™ã€‚å°†æ¥ã¯æœ¬æ ¼çš„ãªåŠ¹æœéŸ³ã‚„ã€ä¼æ¥­ã‚³ãƒ©ãƒœã®ã€Œé™å®šãŠç·šé¦™ã€ãªã©ã‚‚æ¤œè¨ã§ãã¾ã™ã€‚
            </div>
          </div>
        </div>
      </section>

      <!-- Profile Tab -->
      <section id="tab-profile" class="tab-panel">
        <div class="section-title">Profile</div>
        <div class="profile-summary" id="profileSummary">
          <div class="profile-summary-title" id="summaryName">ã¾ã äººç‰©ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
          <div class="profile-summary-sub" id="summaryRelation">ä¸Šéƒ¨ã®ã€Œï¼‹è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ã€Œç¥–çˆ¶ã€ã€Œç¥–æ¯ã€ã€Œãƒšãƒƒãƒˆã€ãªã©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>
          <div style="margin-top:4px;" id="summaryDetail">äººç‰©ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã“ã“ã«æ²¡å¹´æœˆæ—¥ã‚„æˆ’åã€ä¸€è¨€ãƒ¡ãƒ¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>

        <div class="note">
          å…¥åŠ›ã—ãŸå†…å®¹ã¯ã€ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
          è¿½åŠ ã—ãŸæ–¹ã”ã¨ã«ã€åˆ¥ã€…ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
          ã‚µãƒ¼ãƒãƒ¼ã¸ã®é€ä¿¡ã¯è¡Œã‚ã‚Œãªã„ã€ã‚ãã¾ã§ãƒ‡ãƒ¢ç”¨ã®ç”»é¢ã§ã™ã€‚
        </div>

        <div class="profile-form-grid">
          <div>
            <label for="profileNameInput">ãŠåå‰</label>
            <input id="profileNameInput" type="text" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ ã•ã‚“">
          </div>
          <div>
            <label for="profileRelationInput">ã‚ãªãŸã¨ã®é–¢ä¿‚</label>
            <input id="profileRelationInput" type="text" placeholder="ä¾‹ï¼‰ã‚ãªãŸã®ãŠã˜ã„ã¡ã‚ƒã‚“ï¼ˆçˆ¶æ–¹ï¼‰">
          </div>
          <div>
            <label for="profileDeathDateInput">æ²¡å¹´æœˆæ—¥</label>
            <input id="profileDeathDateInput" type="date">
          </div>
          <div>
            <label for="profileKaimyoInput">æˆ’åï¼ˆã‚ã‚Œã°ï¼‰</label>
            <input id="profileKaimyoInput" type="text" placeholder="ä¾‹ï¼‰â—‹â—‹é™¢â–³â–³å±…å£«">
          </div>
          <div>
            <label for="profileMemoInput">æ€ã„å‡ºãƒ¡ãƒ¢ãƒ»ä¸€è¨€</label>
            <textarea id="profileMemoInput" placeholder="ä¾‹ï¼‰ä¸€ç·’ã«é‡£ã‚Šã«è¡Œã£ãŸå¤ã®ã“ã¨ã¯ä¸€ç”Ÿå¿˜ã‚Œã¾ã›ã‚“ã€‚"></textarea>
          </div>
        </div>

        <div class="profile-save-row">
          <span class="save-status" id="profileSaveStatus"></span>
          <button id="btnResetProfile" type="button" class="btn btn-ghost">å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btnSaveProfile" type="button" class="btn btn-primary">ã“ã®ç«¯æœ«ã«ä¿å­˜ã—ã¦åæ˜ ï¼ˆã“ã®æ–¹ï¼‰</button>
        </div>

        <div class="danger-zone">
          <div class="danger-zone-title">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆ</div>
          <div>
            ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¢ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆäººç‰©ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»éºå½±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ä»å£‡è¨­å®šãƒ»ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚<br>
            ã‚‚ã†ä¸€åº¦ã¾ã£ã•ã‚‰ãªçŠ¶æ…‹ã‹ã‚‰è©¦ã—ãŸã„ã¨ãã«ä½¿ã„ã¾ã™ã€‚
          </div>
          <button id="btnResetAllData" type="button" class="btn btn-small btn-ghost" style="margin-top:4px;border-color:#a55;color:#f88;">
            ã“ã®ç«¯æœ«ã®ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤
          </button>
        </div>
      </section>

      <!-- Audio Tab -->
      <section id="tab-audio" class="tab-panel">
        <div class="section-title">Audio (Plan)</div>
        <div class="audio-grid">
          <div class="audio-card">
            <div class="audio-phrase">ã€Œã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã€‚ã€</div>
            <div class="audio-note">
              å°†æ¥ã®ã‚¢ãƒ—ãƒªç‰ˆã§ã¯ã€ã“ã“ã«æ•…äººã®å£°ã‚’å†ç¾ã—ãŸéŸ³å£°ãƒœã‚¿ãƒ³ãŒä¸¦ã³ã¾ã™ã€‚<br>
              ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸéŸ³å£°ã‚’ã‚‚ã¨ã«ã€Œã‚ã‚ŠãŒã¨ã†ã€ã€Œå…ƒæ°—ã«ã—ã¦ã„ã‚‹ã‹ã„ï¼Ÿã€ãªã©ã‚’å†ç”Ÿã§ãã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
            </div>
          </div>
          <div class="audio-card">
            <div class="audio-phrase">ã€ŒãŸã¾ã«ã¯ãŠå¢“å‚ã‚Šã«ã‚‚æ¥ã¦ã­ã€‚ã€</div>
            <div class="audio-note">
              å£°ã®å†ç¾ã¯ã€åŒæ„ã‚’å¾—ãŸæ–¹ã®ã¿ãƒ»å®‰å…¨ã«é…æ…®ã—ãŸç¯„å›²ã§å®Ÿè£…äºˆå®šã§ã™ã€‚<br>
              ã“ã®HTMLãƒ‡ãƒ¢ã§ã¯å®Ÿéš›ã®éŸ³å£°å†ç”Ÿã¯è¡Œã„ã¾ã›ã‚“ã€‚
            </div>
          </div>
          <div class="audio-card">
            <div class="audio-phrase">ã“ã®æ–¹ã®ãƒ•ãƒ¬ãƒ¼ã‚ºå€™è£œï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰</div>
            <div style="font-size:11px;color:#bbb;margin-bottom:4px;">
              å°†æ¥ã®éŸ³å£°æ©Ÿèƒ½ã§ä½¿ã†ã‹ã‚‚ã—ã‚Œãªã„è¨€è‘‰ã‚’ã€äººç‰©ã”ã¨ã«ãƒ¡ãƒ¢ã—ã¦ãŠãæ¬„ã§ã™ï¼ˆéŸ³å£°ã¯å†ç”Ÿã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚
            </div>
            <textarea id="audioPhraseInput" rows="2" placeholder="ä¾‹ï¼‰ã„ã¤ã‚‚è¦‹å®ˆã£ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚"></textarea>
            <div style="margin-top:4px;display:flex;gap:6px;justify-content:flex-end;align-items:center;">
              <span id="audioPhraseSaveStatus" style="font-size:10px;color:#9fd69f;"></span>
              <button id="btnAddAudioPhrase" type="button" class="btn btn-small">ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¿½åŠ ï¼ˆã“ã®æ–¹ï¼‰</button>
            </div>
            <div style="margin-top:6px;">
              <div style="font-size:11px;color:#bbb;margin-bottom:2px;">ç™»éŒ²æ¸ˆã¿ã®ãƒ•ãƒ¬ãƒ¼ã‚º</div>
              <ul id="audioPhraseList" style="margin:0;padding-left:18px;font-size:11px;color:#ddd;"></ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Shukatsu Tab -->
      <section id="tab-shukatsu" class="tab-panel">
        <div class="section-title">Shukatsu</div>
        <div class="shukatsu-grid">
          <div class="shukatsu-card">
            <div class="shukatsu-title">ç”Ÿå‰æº–å‚™ãƒ¡ãƒ¢ï¼ˆè‡ªåˆ†ã®ã“ã¨ï¼‰</div>
            <div class="shukatsu-sub">
              å°†æ¥ã®ã”è‡ªèº«ã®ã€Œãƒ‡ã‚¸ã‚¿ãƒ«ä»å£‡ã€ã«ä½¿ã†ã‹ã‚‚ã—ã‚Œãªã„æƒ…å ±ã‚’ã€ç°¡å˜ã«ãƒ¡ãƒ¢ã—ã¦ãŠããŸã‚ã®æ¬„ã§ã™ã€‚<br>
              ã“ã®HTMLãƒ‡ãƒ¢ã§ã¯ã€ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚
            </div>
            <div class="profile-form-grid">
              <div>
                <label for="shukatsuNameInput">è‡ªåˆ†ã®åå‰</label>
                <input id="shukatsuNameInput" type="text" placeholder="ä¾‹ï¼‰å±±ç”° èŠ±å­">
              </div>
              <div>
                <label for="shukatsuNickInput">å‘¼ã‚“ã§ã»ã—ã„åå‰ãƒ»å‘¼ã³æ–¹</label>
                <input id="shukatsuNickInput" type="text" placeholder="ä¾‹ï¼‰ã¯ãªã¡ã‚ƒã‚“ã€ãŠã‹ã‚ã•ã‚“ ãªã©">
              </div>
              <div>
                <label for="shukatsuFavoritesInput">å¥½ããªã‚‚ã®ãƒ»ãŠä¾›ãˆã—ã¦ã»ã—ã„ã‚‚ã®</label>
                <textarea id="shukatsuFavoritesInput" placeholder="ä¾‹ï¼‰ãƒ“ãƒ¼ãƒ«ã€å’Œè“å­ã€ã‚³ãƒ¼ãƒ’ãƒ¼ã€ãƒ©ãƒ¼ãƒ¡ãƒ³ã€â—‹â—‹ã¨ã„ã†æ›²ã€â–³â–³ã¨ã„ã†å ´æ‰€ ãªã©"></textarea>
              </div>
              <div>
                <label for="shukatsuMessageInput">å®¶æ—ã‚„å¤§åˆ‡ãªäººã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒ¡ãƒ¢ï¼‰</label>
                <textarea id="shukatsuMessageInput" placeholder="ä¾‹ï¼‰ç„¡ç†ã—ã™ããšã€ç¬‘ã£ã¦éã”ã—ã¦ã­ã€‚ã„ã¤ã‚‚ãã°ã§è¦‹å®ˆã£ã¦ã„ã¾ã™ã€‚"></textarea>
              </div>
            </div>
            <div class="shukatsu-save-row">
              <span id="shukatsuSaveStatus" class="shukatsu-save-status"></span>
              <button id="btnSaveShukatsu" type="button" class="btn btn-primary btn-small">ã“ã®ç«¯æœ«ã«çµ‚æ´»ãƒ¡ãƒ¢ã‚’ä¿å­˜ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</button>
            </div>
          </div>
          <div class="shukatsu-card">
            <div class="shukatsu-title">ã“ã®çµ‚æ´»ã‚¿ãƒ–ã«ã¤ã„ã¦</div>
            <div style="font-size:11px;color:#ccc;line-height:1.6;">
              ãƒ»æœ¬ç•ªã‚¢ãƒ—ãƒªã§ã¯ã€ã€Œç”Ÿå‰ãƒ¢ãƒ¼ãƒ‰ã€ã¨ã—ã¦ã”æœ¬äººã®å¸Œæœ›ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å°‘ã—ãšã¤æ›¸ãæ®‹ã—ã¦ã„ã‘ã‚‹æ©Ÿèƒ½ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚<br>
              ãƒ»å°†æ¥çš„ã«ã¯ã€ã”å®¶æ—ç”¨ã®ã€Œä¾›é¤Šãƒ¢ãƒ¼ãƒ‰ã€ã¨ã¤ãªã’ã¦ã€ã€Œç”Ÿå‰ã«æ®‹ã—ã¦ãã‚ŒãŸãƒ¡ãƒ¢ã€ã‚’ãƒ‡ã‚¸ã‚¿ãƒ«ä»å£‡ã«ã‚‚åæ˜ ã§ãã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚<br>
              ãƒ»ã“ã®HTMLãƒ‡ãƒ¢ã§ã¯ã€ã‚ãã¾ã§å…¥åŠ›UIã¨ç«¯æœ«å†…ä¿å­˜ã®ã¿ã‚’ä½“é¨“ã™ã‚‹å½¢ã§ã™ã€‚
            </div>
          </div>
        </div>
      </section>

      <div class="divider"></div>
      <div class="footer">
        ãƒ‡ã‚¸ã‚¿ãƒ«ä»å£‡ã‚¢ãƒ—ãƒª ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— v11.1.1 / vA10releaseï¼ˆHTMLãƒ‡ãƒ¢ï¼‰<br>
        ãƒ»äººç‰©ã¯æœ€åˆã€Œï¼‹è¿½åŠ ã€ã®ã¿ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œç¥–çˆ¶ã€ã€Œç¥–æ¯ã€ã€Œãƒšãƒƒãƒˆã€ãªã©è‡ªç”±ã«ç™»éŒ²<br>
        ãƒ»ä»å£‡ã®éºå½±åã¯ã€Œãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŠåå‰ã€ï¼ã€Œï¼‹è¿½åŠ ãƒ©ãƒ™ãƒ«ã€ï¼ã€Œå¤§åˆ‡ãªæ–¹ã€ã®é †ã§è¡¨ç¤º<br>
        ãƒ»äººç‰©ã”ã¨ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼éºå½±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ä»å£‡è¨­å®šï¼ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ localStorage ã«ä¿å­˜ãƒ»å‰Šé™¤<br>
        ãƒ»éˆ´ãƒœã‚¿ãƒ³ï¼ç·šé¦™ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼‹é¦™ç‚‰ã®ç…™ã¤ãï¼ˆ15ç§’ãƒ»30ç§’ãƒ»1åˆ†ï¼‰<br>
        ãƒ»ã€Œã‚ˆãä½¿ã†ãŠä¾›ãˆã€ãƒœã‚¿ãƒ³ï¼ã€Œæœ€è¿‘ã®ãŠä¾›ãˆã€å±¥æ­´ï¼ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ã<br>
        ãƒ»ãƒ“ãƒ¼ãƒ«ãƒ»å’Œè“å­ãƒ»ã‚³ãƒ¼ãƒ’ãƒ¼ãƒ»ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯ãƒ»æ—¥æœ¬é…’ãƒ»ã‚«ãƒƒãƒ—éººã®ã€ŒãŠä¾›ãˆã‚«ã‚¿ãƒ­ã‚°ï¼ˆå®Ÿåœ¨å•†å“ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ã€è¿½åŠ <br>
        ãƒ»å‰å›åˆ©ç”¨ã‹ã‚‰æ•°æ—¥ã‚ã„ãŸã¨ãã«ã€Œã€‡ã€‡ã•ã‚“ãŒå‘¼ã‚“ã§ã„ã¾ã™ã€ã‚«ãƒ¼ãƒ‰ï¼‹ã€Œã‚ã‚ŠãŒã¨ã†ã€ãƒ‡ãƒ¢éŸ³ï¼ˆHTMLå†…ã®ã¿ï¼‰<br>
        ãƒ»çµ‚æ´»ã‚¿ãƒ–ï¼ˆç”Ÿå‰æº–å‚™ãƒ¡ãƒ¢ç”¨UIãƒ»ã“ã®ç«¯æœ«ã«ã ã‘ä¿å­˜ï¼‰ã‚’è¿½åŠ <br>
        <span class="badge">ãƒ†ã‚¹ãƒˆç”¨ / å®Ÿã‚µãƒ¼ãƒ“ã‚¹ã¨ã¯ç•°ãªã‚Šã¾ã™</span>
      </div>
    </div>
  </div>

  <script>
    const profileChipContainer = document.getElementById("profileChipContainer");
    const profileCountLabel = document.getElementById("profileCountLabel");
    const btnDeleteProfile = document.getElementById("btnDeleteProfile");
    const PROFILE_LIST_KEY = "digital_altar_profile_list_vA10j";
    const LAST_OPEN_KEY = "digital_altar_last_open_vA10k";
    let currentProfileId = null;
    let profileList = [];

    function safeLoad(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch (e) { return fallback; }
    }
    function safeSave(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {}
    }

    function loadProfileList() {
      const saved = safeLoad(PROFILE_LIST_KEY, []);
      if (Array.isArray(saved)) profileList = saved;
      if (!profileList.some(p => p.id === currentProfileId)) {
        currentProfileId = profileList.length ? profileList[0].id : null;
      }
    }
    function saveProfileList() { safeSave(PROFILE_LIST_KEY, profileList); }

    function updateProfileCountLabel() {
      if (!profileCountLabel) return;
      const count = profileList.length || 0;
      if (!count) profileCountLabel.textContent = "ï¼ˆç™»éŒ²ãªã—ï¼‰";
      else profileCountLabel.textContent = "ç™»éŒ²äººæ•°ï¼š" + count + "äºº";
    }

    function renderProfileChips() {
      profileChipContainer.innerHTML = "";
      profileList.forEach(p => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "profile-chip" + (p.id === currentProfileId ? " active" : "");
        btn.textContent = p.label;
        btn.addEventListener("click", () => {
          if (p.id !== currentProfileId) switchProfile(p.id);
        });
        profileChipContainer.appendChild(btn);
      });
      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.className = "profile-chip add";
      addBtn.textContent = "ï¼‹ è¿½åŠ ";
      addBtn.addEventListener("click", () => {
        const label = window.prompt("è¿½åŠ ã™ã‚‹æ–¹ã®å‘¼ã³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šç¥–çˆ¶ã€ç¥–æ¯ã€çˆ¶ã€æ¯ã€ãƒšãƒƒãƒˆã€æ¨ã— ãªã©ï¼‰");
        if (!label) return;
        const name = label.trim();
        if (!name) return;
        const id = "p_" + Date.now().toString(36);
        profileList.push({ id, label: name });
        saveProfileList();
        currentProfileId = id;
        switchProfile(id);
      });
      profileChipContainer.appendChild(addBtn);

      if (btnDeleteProfile) {
        btnDeleteProfile.style.display = profileList.length && currentProfileId ? "inline-flex" : "none";
      }
      updateProfileCountLabel();
    }

    function getStorageKey(base) {
      if (!currentProfileId) return base + "_no_profile";
      return base + "_" + currentProfileId;
    }

    const STORAGE_PROFILE_BASE = "digital_altar_profile_vA10j";
    const STORAGE_PORTRAIT_BASE = "digital_altar_portrait_status_vA10j";
    const STORAGE_ALTAR_BASE   = "digital_altar_altar_vA10j";
    const STORAGE_OFFERING_HISTORY_BASE = "digital_altar_offering_history_vA10j";
    const STORAGE_AUDIO_BASE   = "digital_altar_audio_vA10j";
    const SHUKATSU_KEY = "digital_altar_shukatsu_self_vA10k";

    const tabButtons = document.querySelectorAll(".step-nav button");
    const tabPanels = {
      portrait: document.getElementById("tab-portrait"),
      altar: document.getElementById("tab-altar"),
      profile: document.getElementById("tab-profile"),
      audio: document.getElementById("tab-audio"),
      shukatsu: document.getElementById("tab-shukatsu")
    };
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        Object.keys(tabPanels).forEach(k => {
          tabPanels[k].classList.toggle("active", k === tab);
        });
      });
    });

    const portraitStatusPill = document.getElementById("portraitStatusPill");
    const portraitStatusText = document.getElementById("portraitStatusText");
    const ihaiPreviewTextEl = document.getElementById("ihaiPreviewText");
    const altarIhaiEl = document.getElementById("altarIhai");
    const altarRinEl = document.getElementById("altarRin");
    const altarRinStickEl = document.getElementById("altarRinStick");
    const toggleIhaiEl = document.getElementById("toggleIhai");
    const toggleIncenseEl = document.getElementById("toggleIncense");
    const toggleRinEl = document.getElementById("toggleRin");
    const toggleRinStickEl = document.getElementById("toggleRinStick");
    const btnRequestPortrait = document.getElementById("btnRequestPortrait");
    const btnApprovePortrait = document.getElementById("btnApprovePortrait");
    const altarPortraitStatusEl = document.getElementById("altarPortraitStatus");
    const altarPortraitSmallEl = document.getElementById("altarPortraitSmall");

    const PORTRAIT_STATUS = { UNSUBMITTED:"unsubmitted", REVIEW:"review", APPROVED:"approved" };

    function defaultNameForPortrait() {
      const profile = safeLoad(getStorageKey(STORAGE_PROFILE_BASE), null);
      if (profile && profile.name && profile.name.trim()) return profile.name.trim();
      const found = profileList.find(p => p.id === currentProfileId);
      if (found && found.label) return found.label + " ã•ã‚“";
      return "å¤§åˆ‡ãªæ–¹";
    }

    function updatePortraitUI(status) {
      portraitStatusPill.classList.remove("status-unsubmitted","status-review","status-approved");
      let label = "", text = "";
      if (!currentProfileId) status = PORTRAIT_STATUS.UNSUBMITTED;
      if (status === PORTRAIT_STATUS.REVIEW) {
        portraitStatusPill.classList.add("status-review");
        label = "å¯©æŸ»ä¸­";
        text = "é‹å–¶ã«éºå½±ã®ç”³è«‹ãŒé€ä¿¡ã•ã‚Œã€ã‚¹ã‚¿ãƒƒãƒ•ãŒç¢ºèªã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚\nå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã€å¯©æŸ»ãŒå®Œäº†ã™ã‚‹ã¨è‡ªå‹•ã§ã€Œæ‰¿èªã€ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚";
        altarPortraitStatusEl.textContent = "éºå½±ï¼šå¯©æŸ»ä¸­";
        altarPortraitSmallEl.textContent = "å¯©æŸ»ä¸­";
        altarPortraitSmallEl.classList.remove("approved");
      } else if (status === PORTRAIT_STATUS.APPROVED) {
        portraitStatusPill.classList.add("status-approved");
        label = "æ‰¿èªæ¸ˆ";
        text = "éºå½±ã®å¯©æŸ»ãŒå®Œäº†ã—ã€æ‰¿èªã•ã‚ŒãŸçŠ¶æ…‹ã§ã™ã€‚\nä»å£‡ã‚¿ãƒ–ã®éºå½±ã«ã‚‚åæ˜ ã•ã‚Œã€è¡¨ç¤ºãŒæ˜ã‚‹ããªã‚Šã¾ã™ã€‚";
        altarPortraitStatusEl.textContent = "éºå½±ï¼šæ‰¿èªæ¸ˆ";
        altarPortraitSmallEl.textContent = defaultNameForPortrait();
        altarPortraitSmallEl.classList.add("approved");
      } else {
        portraitStatusPill.classList.add("status-unsubmitted");
        label = "æœªç”³è«‹";
        text = "ã¾ã éºå½±ã®ç”³è«‹ã¯è¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ã“ã“ã‹ã‚‰å†™çœŸã‚’é€ä¿¡ã—ã¦å¯©æŸ»ã‚’ä¾é ¼ã—ã¾ã™ã€‚";
        altarPortraitStatusEl.textContent = "éºå½±ï¼šæœªæ‰¿èª";
        altarPortraitSmallEl.textContent = "éºå½±ç¢ºèªä¸­";
        altarPortraitSmallEl.classList.remove("approved");
      }
      portraitStatusPill.querySelector("span").textContent = label;
      portraitStatusText.innerHTML = text.replace(/\n/g,"<br>");
      if (currentProfileId) safeSave(getStorageKey(STORAGE_PORTRAIT_BASE), { status });
    }

    btnRequestPortrait.addEventListener("click", () => {
      if (!currentProfileId) { alert("å…ˆã«ä¸Šéƒ¨ã®ã€Œï¼‹è¿½åŠ ã€ã‹ã‚‰äººç‰©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; }
      updatePortraitUI(PORTRAIT_STATUS.REVIEW);
    });
    btnApprovePortrait.addEventListener("click", () => {
      if (!currentProfileId) { alert("å…ˆã«ä¸Šéƒ¨ã®ã€Œï¼‹è¿½åŠ ã€ã‹ã‚‰äººç‰©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; }
      updatePortraitUI(PORTRAIT_STATUS.APPROVED);
    });

    const altarPreviewEl = document.getElementById("altarPreview");
    const altarLabelEl = document.getElementById("altarLabel");
    const altarItemsInputEl = document.getElementById("altarItemsInput");
    const altarItemsRowEl = document.getElementById("altarItemsRow");
    const altarStyleSelectEl = document.getElementById("altarStyleSelect");
    const btnApplyAltar = document.getElementById("btnApplyAltar");
    const incenseAreaEl = document.getElementById("incenseArea");
    const quickOfferingButtons = document.querySelectorAll(".quick-offering");
    const offeringHistoryListEl = document.getElementById("offeringHistoryList");

    function applyAltarStyle(style) {
      altarPreviewEl.classList.remove("alt-basic","alt-gold","alt-modern");
      let label = "";
      if (style === "gold") { altarPreviewEl.classList.add("alt-gold"); label = "é‡‘ä»å£‡ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰"; }
      else if (style === "modern") { altarPreviewEl.classList.add("alt-modern"); label = "ãƒ¢ãƒ€ãƒ³ä»å£‡ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰"; }
      else { altarPreviewEl.classList.add("alt-basic"); label = "ã‚·ãƒ³ãƒ—ãƒ«ãªä»å£‡ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰"; }
      altarLabelEl.textContent = label;
    }
    function applyAltarItems(text) {
      altarItemsRowEl.innerHTML = "";
      const base = text || "ãŠç·šé¦™, ãŠèŠ±";
      base.split(",").map(s=>s.trim()).filter(Boolean).forEach(p => {
        const pill = document.createElement("div");
        pill.className = "altar-item-pill";
        pill.textContent = p;
        altarItemsRowEl.appendChild(pill);
      });
    }

    function renderOfferingHistory(list) {
      if (!offeringHistoryListEl) return;
      if (!list || !list.length) {
        offeringHistoryListEl.textContent = "ã¾ã è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }
      offeringHistoryListEl.innerHTML = list.map((t,i) => (i+1) + "ï¼" + t).join("<br>");
    }

    function saveOfferingHistory(itemsText) {
      if (!currentProfileId) return;
      const trimmed = (itemsText || "").trim();
      if (!trimmed) return;
      const key = STORAGE_OFFERING_HISTORY_BASE + "_" + currentProfileId;
      const current = safeLoad(key, []);
      const updated = [trimmed, ...current.filter(v => v !== trimmed)].slice(0,5);
      safeSave(key, updated);
      renderOfferingHistory(updated);
    }

    function loadOfferingHistory() {
      if (!currentProfileId) {
        renderOfferingHistory([]);
        return;
      }
      const list = safeLoad(STORAGE_OFFERING_HISTORY_BASE + "_" + currentProfileId, []);
      renderOfferingHistory(list);
    }

    btnApplyAltar.addEventListener("click", () => {
      const style = altarStyleSelectEl.value;
      const items = altarItemsInputEl.value;
      applyAltarStyle(style);
      applyAltarItems(items);
      if (currentProfileId) {
        safeSave(getStorageKey(STORAGE_ALTAR_BASE), { style, items });
        saveOfferingHistory(items);
      } else {
        alert("å…ˆã«ä¸Šéƒ¨ã®ã€Œï¼‹è¿½åŠ ã€ã‹ã‚‰äººç‰©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
      }
    });

    document.querySelectorAll(".btn-catalog-choose").forEach(btn => {
      btn.addEventListener("click", () => {
        const card = btn.closest(".catalog-card");
        const style = card.getAttribute("data-style") || "basic";
        altarStyleSelectEl.value = style;
        applyAltarStyle(style);
        if (currentProfileId) safeSave(getStorageKey(STORAGE_ALTAR_BASE), { style, items: altarItemsInputEl.value });
      });
    });

    quickOfferingButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const word = btn.dataset.offering || btn.textContent.trim();
        let current = altarItemsInputEl.value.trim();
        if (!current) altarItemsInputEl.value = word;
        else if (!current.includes(word)) altarItemsInputEl.value = current + ", " + word;
      });
    });

    document.querySelectorAll(".btn-offer-digital").forEach(btn => {
      btn.addEventListener("click", () => {
        const word = btn.dataset.offering || btn.textContent.trim();
        let current = altarItemsInputEl.value.trim();
        if (!current) altarItemsInputEl.value = word;
        else if (!current.includes(word)) altarItemsInputEl.value = current + ", " + word;
        alert("ã€Œ" + word + "ã€ã‚’ãŠä¾›ãˆå€™è£œã«è¿½åŠ ã—ã¾ã—ãŸã€‚\nã€Œä»å£‡ã«åæ˜ ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§ã€ã“ã®æ–¹ã®ä»å£‡ã«åæ˜ ã•ã‚Œã¾ã™ã€‚");
      });
    });

    document.querySelectorAll(".btn-offer-buy").forEach(btn => {
      btn.addEventListener("click", () => {
        alert("å®Ÿç‰©ã‚’æ³¨æ–‡ã™ã‚‹ãŸã‚ã®ECã‚µã‚¤ãƒˆã¸é·ç§»ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚\nå°†æ¥çš„ã«ã€ãƒ“ãƒ¼ãƒ«ä¼šç¤¾ãƒ»é…’é€ ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»è“å­ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»ã‚«ãƒƒãƒ—éººãƒ¡ãƒ¼ã‚«ãƒ¼ç­‰ã¨é€£æºã—ã¦å®Ÿè£…äºˆå®šã§ã™ã€‚");
      });
    });

    const btnRingBell = document.getElementById("btnRingBell");
    const bellStatus = document.getElementById("bellStatus");
    const incenseButtons = document.querySelectorAll("button[data-incense]");
    const incenseStatus = document.getElementById("incenseStatus");
    let incenseTimerId = null;
    let incenseRemaining = 0;
    let audioCtx = null;

    function ringBellSound() {
      try {
        if (!audioCtx) {
          const AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return;
          audioCtx = new AC();
        }
        const ctx = audioCtx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 1000;
        gain.gain.setValueAtTime(0, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.5, ctx.currentTime + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.9);
      } catch (e) {}
    }

    btnRingBell.addEventListener("click", () => {
      ringBellSound();
      bellStatus.textContent = "ãƒãƒ¼ãƒ³â€¦";
      setTimeout(() => { bellStatus.textContent = ""; }, 1500);
    });

    function startIncense(seconds) {
      if (incenseTimerId) { clearInterval(incenseTimerId); incenseTimerId = null; }
      incenseRemaining = seconds;
      updateIncenseStatus();
      incenseButtons.forEach(b => b.disabled = true);
      incenseAreaEl.classList.add("active");
      incenseTimerId = setInterval(() => {
        incenseRemaining -= 1;
        if (incenseRemaining <= 0) {
          clearInterval(incenseTimerId);
          incenseTimerId = null;
          incenseStatus.textContent = "ç·šé¦™ãŒç„šãçµ‚ã‚ã‚Šã¾ã—ãŸã€‚";
          incenseButtons.forEach(b => b.disabled = false);
          setTimeout(() => {
            incenseStatus.textContent = "";
            incenseAreaEl.classList.remove("active");
          }, 3000);
        } else {
          updateIncenseStatus();
        }
      }, 1000);
    }
    function updateIncenseStatus() {
      incenseStatus.textContent = "ç·šé¦™ï¼šæ®‹ã‚Š " + incenseRemaining + " ç§’";
    }
    incenseButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const sec = Number(btn.dataset.incense || "0");
        if (sec > 0) startIncense(sec);
      });
    });


    function makeDraggable(el) {
      if (!el) return;
      let isDown = false;
      let offsetX = 0;
      let offsetY = 0;
      let elemW = 0;
      let elemH = 0;

      el.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        isDown = true;
        try { el.setPointerCapture(e.pointerId); } catch (err) {}
        const rect = el.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        elemW = rect.width;
        elemH = rect.height;
      });
      el.addEventListener("pointermove", (e) => {
        if (!isDown) return;
        const containerRect = altarPreviewEl.getBoundingClientRect();
        let x = e.clientX - containerRect.left - offsetX;
        let y = e.clientY - containerRect.top - offsetY;
        if (x < 0) x = 0;
        if (y < 0) y = 0;
        if (x > containerRect.width - elemW) x = containerRect.width - elemW;
        if (y > containerRect.height - elemH) y = containerRect.height - elemH;
        el.style.left = x + "px";
        el.style.top = y + "px";
        el.style.right = "auto";
        el.style.bottom = "auto";
        el.style.transform = "none";
      });
      el.addEventListener("pointerup", (e) => {
        isDown = false;
        try { el.releasePointerCapture(e.pointerId); } catch (err) {}
      });
      el.addEventListener("pointercancel", (e) => {
        isDown = false;
        try { el.releasePointerCapture(e.pointerId); } catch (err) {}
      });
    }

    function initDraggables() {
      const list = document.querySelectorAll(".altar-draggable");
      list.forEach(el => makeDraggable(el));
    }

    if (toggleIncenseEl && incenseAreaEl) {
      toggleIncenseEl.addEventListener("change", () => {
        incenseAreaEl.style.display = toggleIncenseEl.checked ? "" : "none";
      });
    }
    if (toggleRinEl && altarRinEl) {
      toggleRinEl.addEventListener("change", () => {
        altarRinEl.style.display = toggleRinEl.checked ? "" : "none";
      });
    }
    if (toggleRinStickEl && altarRinStickEl) {
      toggleRinStickEl.addEventListener("change", () => {
        altarRinStickEl.style.display = toggleRinStickEl.checked ? "" : "none";
      });
    }
    if (toggleIhaiEl) {
      toggleIhaiEl.addEventListener("change", () => {
        updateIhaiUI();
      });
    }

    const profileSummaryName = document.getElementById("summaryName");
    const profileSummaryRelation = document.getElementById("summaryRelation");
    const profileSummaryDetail = document.getElementById("summaryDetail");
    const profileNameInput = document.getElementById("profileNameInput");
    const profileRelationInput = document.getElementById("profileRelationInput");
    const profileDeathDateInput = document.getElementById("profileDeathDateInput");
    const profileKaimyoInput = document.getElementById("profileKaimyoInput");
    const profileMemoInput = document.getElementById("profileMemoInput");
    const btnSaveProfile = document.getElementById("btnSaveProfile");
    const btnResetProfile = document.getElementById("btnResetProfile");
    const profileSaveStatus = document.getElementById("profileSaveStatus");
    const btnResetAllData = document.getElementById("btnResetAllData");

    function formatDateJP(dateStr) {
      if (!dateStr) return "----å¹´--æœˆ--æ—¥ï¼ˆæœªè¨­å®šï¼‰";
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return "----å¹´--æœˆ--æ—¥ï¼ˆæœªè¨­å®šï¼‰";
      return d.getFullYear() + "å¹´" + (d.getMonth()+1) + "æœˆ" + d.getDate() + "æ—¥ã”ã‚";
    }
    function defaultRelationForProfile() { return "ã‚ãªãŸã®å¤§åˆ‡ãªæ–¹"; }
    function defaultMemoForProfile() { return "ã„ã¤ã‚‚è¦‹å®ˆã£ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ç„¡ç†ã—ã™ããšã€å…ƒæ°—ã§éã”ã™ã‚“ã ã‚ˆã€‚"; }

    function getIhaiTextForCurrentProfile() {
      if (!currentProfileId) return "";
      const p = safeLoad(getStorageKey(STORAGE_PROFILE_BASE), null);
      let base = "";
      if (p) {
        if (p.kaimyo && p.kaimyo.trim()) {
          base = p.kaimyo.trim();
        } else if (p.name && p.name.trim()) {
          base = p.name.trim();
        }
      }
      if (!base) {
        const found = profileList.find(pf => pf.id === currentProfileId);
        if (found && found.label) base = found.label + " ä½ç‰Œ";
      }
      return base;
    }

    function updateIhaiUI() {
      const text = currentProfileId ? getIhaiTextForCurrentProfile() : "";
      const visibleByToggle = !toggleIhaiEl || toggleIhaiEl.checked;

      if (ihaiPreviewTextEl) {
        if (text) {
          ihaiPreviewTextEl.textContent = text;
        } else {
          ihaiPreviewTextEl.textContent = "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ãƒ–ã§ã€Œæˆ’åã€ã¾ãŸã¯ãŠåå‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«ä½ç‰Œã®æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
        }
      }
      if (altarIhaiEl) {
        if (text && visibleByToggle) {
          altarIhaiEl.style.display = "block";
          altarIhaiEl.textContent = text;
        } else {
          altarIhaiEl.style.display = "none";
          altarIhaiEl.textContent = text || "";
        }
      }
    }

    function defaultNameForSummary() {
      const profile = safeLoad(getStorageKey(STORAGE_PROFILE_BASE), null);
      if (profile && profile.name && profile.name.trim()) return profile.name.trim();
      const found = profileList.find(p => p.id === currentProfileId);
      if (found && found.label) return found.label + " ã•ã‚“";
      return "å¤§åˆ‡ãªæ–¹";
    }

    function applyProfileToSummary(p) {
      if (!currentProfileId) {
        profileSummaryName.textContent = "ã¾ã äººç‰©ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“";
        profileSummaryRelation.textContent = "ä¸Šéƒ¨ã®ã€Œï¼‹è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ã€Œç¥–çˆ¶ã€ã€Œç¥–æ¯ã€ã€Œãƒšãƒƒãƒˆã€ãªã©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚";
        profileSummaryDetail.innerHTML = "äººç‰©ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã“ã“ã«æ²¡å¹´æœˆæ—¥ã‚„æˆ’åã€ä¸€è¨€ãƒ¡ãƒ¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
        return;
      }
      const name = (p && p.name && p.name.trim()) ? p.name.trim() : defaultNameForSummary();
      const relation = (p && p.relation && p.relation.trim()) ? p.relation.trim() : defaultRelationForProfile();
      const deathText = formatDateJP(p && p.deathDate);
      const kaimyo = (p && p.kaimyo && p.kaimyo.trim()) ? p.kaimyo.trim() : "æœªè¨­å®š";
      const memo = (p && p.memo && p.memo.trim()) ? p.memo.trim() : defaultMemoForProfile();
      profileSummaryName.textContent = name;
      profileSummaryRelation.textContent = relation;
      profileSummaryDetail.innerHTML = "æ²¡å¹´æœˆæ—¥ï¼š" + deathText + "<br>æˆ’åï¼š" + kaimyo + "<br>ä¸€è¨€ãƒ¡ãƒ¢ï¼š" + memo;

      const pStatus = safeLoad(getStorageKey(STORAGE_PORTRAIT_BASE), {});
      if (pStatus && pStatus.status === PORTRAIT_STATUS.APPROVED) {
        altarPortraitSmallEl.textContent = defaultNameForPortrait();
        altarPortraitSmallEl.classList.add("approved");
      }
      updateIhaiUI();
    }

    function loadProfile() {
      if (!currentProfileId) {
        profileNameInput.value = "";
        profileRelationInput.value = "";
        profileDeathDateInput.value = "";
        profileKaimyoInput.value = "";
        profileMemoInput.value = "";
        applyProfileToSummary({});
        return;
      }
      const saved = safeLoad(getStorageKey(STORAGE_PROFILE_BASE), null);
      if (saved) {
        profileNameInput.value = saved.name || "";
        profileRelationInput.value = saved.relation || "";
        profileDeathDateInput.value = saved.deathDate || "";
        profileKaimyoInput.value = saved.kaimyo || "";
        profileMemoInput.value = saved.memo || "";
        applyProfileToSummary(saved);
      } else {
        profileNameInput.value = "";
        profileRelationInput.value = "";
        profileDeathDateInput.value = "";
        profileKaimyoInput.value = "";
        profileMemoInput.value = "";
        applyProfileToSummary({});
      }
    }

    btnSaveProfile.addEventListener("click", () => {
      if (!currentProfileId) { alert("å…ˆã«ä¸Šéƒ¨ã®ã€Œï¼‹è¿½åŠ ã€ã‹ã‚‰äººç‰©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; }
      const profile = {
        name: profileNameInput.value.trim(),
        relation: profileRelationInput.value.trim(),
        deathDate: profileDeathDateInput.value,
        kaimyo: profileKaimyoInput.value.trim(),
        memo: profileMemoInput.value.trim()
      };
      safeSave(getStorageKey(STORAGE_PROFILE_BASE), profile);
      applyProfileToSummary(profile);
      updateIhaiUI();
      profileSaveStatus.textContent = "ã“ã®æ–¹ã®æƒ…å ±ã‚’ã€ã“ã®ç«¯æœ«ã«ä¿å­˜ã—ã¾ã—ãŸ";
      setTimeout(() => { profileSaveStatus.textContent = ""; }, 2500);
    });

    btnResetProfile.addEventListener("click", () => {
      profileNameInput.value = "";
      profileRelationInput.value = "";
      profileDeathDateInput.value = "";
      profileKaimyoInput.value = "";
      profileMemoInput.value = "";
      if (currentProfileId) safeSave(getStorageKey(STORAGE_PROFILE_BASE), {});
      applyProfileToSummary({});
      updateIhaiUI();
      profileSaveStatus.textContent = "å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ";
      setTimeout(() => { profileSaveStatus.textContent = ""; }, 2500);
    });

    if (btnResetAllData) {
      btnResetAllData.addEventListener("click", () => {
        if (!window.confirm("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nç™»éŒ²ã—ãŸäººç‰©ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»éºå½±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ä»å£‡è¨­å®šãƒ»ãƒ•ãƒ¬ãƒ¼ã‚ºãŒæ¶ˆãˆã¾ã™ã€‚")) return;
        try {
          const keysToRemove = [];
          for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (k && k.indexOf("digital_altar_") === 0) keysToRemove.push(k);
          }
          keysToRemove.forEach(k => localStorage.removeItem(k));
        } catch (e) {}
        alert("ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ç”»é¢ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚");
        location.reload();
      });
    }

    function loadPortraitStatusForProfile() {
      if (!currentProfileId) { updatePortraitUI(PORTRAIT_STATUS.UNSUBMITTED); return; }
      const savedPortrait = safeLoad(getStorageKey(STORAGE_PORTRAIT_BASE), null);
      if (savedPortrait && savedPortrait.status) updatePortraitUI(savedPortrait.status);
      else updatePortraitUI(PORTRAIT_STATUS.UNSUBMITTED);
    }
    function loadAltarForProfile() {
      const savedAltar = currentProfileId ? safeLoad(getStorageKey(STORAGE_ALTAR_BASE), null) : null;
      if (savedAltar) {
        const style = savedAltar.style || "basic";
        altarStyleSelectEl.value = style;
        applyAltarStyle(style);
        altarItemsInputEl.value = savedAltar.items || "";
        applyAltarItems(savedAltar.items || "");
      } else {
        altarStyleSelectEl.value = "basic";
        applyAltarStyle("basic");
        altarItemsInputEl.value = "";
        applyAltarItems("");
      }
    }

    const audioPhraseInput = document.getElementById("audioPhraseInput");
    const audioPhraseSaveStatus = document.getElementById("audioPhraseSaveStatus");
    const audioPhraseList = document.getElementById("audioPhraseList");
    const btnAddAudioPhrase = document.getElementById("btnAddAudioPhrase");

    function renderAudioPhrases(list) {
      if (!audioPhraseList) return;
      audioPhraseList.innerHTML = "";
      if (!list || !list.length) {
        const li = document.createElement("li");
        li.textContent = "ã¾ã ãƒ•ãƒ¬ãƒ¼ã‚ºã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
        li.style.color = "#999";
        audioPhraseList.appendChild(li);
        return;
      }
      list.forEach(text => {
        const li = document.createElement("li");
        li.textContent = text;
        audioPhraseList.appendChild(li);
      });
    }

    function loadAudioPhrases() {
      if (!currentProfileId) {
        renderAudioPhrases([]);
        return;
      }
      const list = safeLoad(STORAGE_AUDIO_BASE + "_" + currentProfileId, []);
      renderAudioPhrases(list);
    }

    if (btnAddAudioPhrase) {
      btnAddAudioPhrase.addEventListener("click", () => {
        if (!currentProfileId) { alert("å…ˆã«ä¸Šéƒ¨ã®ã€Œï¼‹è¿½åŠ ã€ã‹ã‚‰äººç‰©ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; }
        const text = (audioPhraseInput.value || "").trim();
        if (!text) return;
        const key = STORAGE_AUDIO_BASE + "_" + currentProfileId;
        const list = safeLoad(key, []);
        const updated = [text, ...list].slice(0,10);
        safeSave(key, updated);
        renderAudioPhrases(updated);
        audioPhraseInput.value = "";
        audioPhraseSaveStatus.textContent = "ã“ã®æ–¹ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ä¿å­˜ã—ã¾ã—ãŸ";
        setTimeout(() => { audioPhraseSaveStatus.textContent = ""; }, 2500);
      });
    }

    // çµ‚æ´»ã‚¿ãƒ–ï¼šç”Ÿå‰æº–å‚™ãƒ¡ãƒ¢
    const shukatsuNameInput = document.getElementById("shukatsuNameInput");
    const shukatsuNickInput = document.getElementById("shukatsuNickInput");
    const shukatsuFavoritesInput = document.getElementById("shukatsuFavoritesInput");
    const shukatsuMessageInput = document.getElementById("shukatsuMessageInput");
    const btnSaveShukatsu = document.getElementById("btnSaveShukatsu");
    const shukatsuSaveStatus = document.getElementById("shukatsuSaveStatus");

    function loadShukatsu() {
      if (!shukatsuNameInput) return;
      const data = safeLoad(SHUKATSU_KEY, null);
      if (data) {
        shukatsuNameInput.value = data.name || "";
        shukatsuNickInput.value = data.nick || "";
        shukatsuFavoritesInput.value = data.favorites || "";
        shukatsuMessageInput.value = data.message || "";
      }
    }

    if (btnSaveShukatsu) {
      btnSaveShukatsu.addEventListener("click", () => {
        const data = {
          name: (shukatsuNameInput.value || "").trim(),
          nick: (shukatsuNickInput.value || "").trim(),
          favorites: (shukatsuFavoritesInput.value || "").trim(),
          message: (shukatsuMessageInput.value || "").trim()
        };
        safeSave(SHUKATSU_KEY, data);
        if (shukatsuSaveStatus) {
          shukatsuSaveStatus.textContent = "ã“ã®ç«¯æœ«ã«çµ‚æ´»ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆç”Ÿå‰æº–å‚™ãƒ¢ãƒ¼ãƒ‰ãƒ»ã‚µãƒ³ãƒ—ãƒ«ï¼‰ã€‚";
          setTimeout(() => { shukatsuSaveStatus.textContent = ""; }, 2800);
        }
      });
    }

    // ã€Œã€‡ã€‡ã•ã‚“ãŒå‘¼ã‚“ã§ã„ã¾ã™ã€ã‚«ãƒ¼ãƒ‰ï¼ˆå‰å›åˆ©ç”¨ã‹ã‚‰æ•°æ—¥ã‚ã„ãŸã¨ãï¼‰
    const reengageBanner = document.getElementById("reengageBanner");
    const reengageTitle = document.getElementById("reengageTitle");
    const reengageBody = document.getElementById("reengageBody");
    const reengageStatus = document.getElementById("reengageStatus");
    const btnReengageVoice = document.getElementById("btnReengageVoice");


    function getReengageDisplayName() {
      // è¤‡æ•°äººç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«1äººã‚’é¸ã³ã¾ã™ã€‚
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ãŠåå‰ãŒã‚ã‚Œã°å„ªå…ˆã—ã€æœ€å¾Œã¯ã€Œã•ã‚“ã€ã‚’ä»˜ã‘ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
      if (Array.isArray(profileList) && profileList.length > 0) {
        const idx = Math.floor(Math.random() * profileList.length);
        const meta = profileList[idx];
        let base = "";
        if (meta && meta.id) {
          const key = STORAGE_PROFILE_BASE + "_" + meta.id;
          const p = safeLoad(key, null);
          if (p && p.name && p.name.trim()) {
            base = p.name.trim();
          } else if (meta.label) {
            base = meta.label + " ã•ã‚“";
          }
        }
        if (!base) {
          // å¿µã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          base = defaultNameForSummary();
        }
        if (!/ã•ã‚“$/.test(base)) {
          base += "ã•ã‚“";
        }
        return base;
      }
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒ1äººã‚‚ã„ãªã„å ´åˆã¯ã€å¾“æ¥ã©ãŠã‚Šã®åå‰ã‚’ä½¿ã†
      let base = defaultNameForSummary();
      if (!/ã•ã‚“$/.test(base)) {
        base += "ã•ã‚“";
      }
      return base;
    }

    function showReengageIfNeeded() {
      let now = new Date();
      let lastStr = null;
      try { lastStr = localStorage.getItem(LAST_OPEN_KEY); } catch (e) {}
      let shouldShow = false;
      let diffDays = null;
      if (lastStr) {
        const last = new Date(lastStr);
        if (!isNaN(last.getTime())) {
          const diffMs = now.getTime() - last.getTime();
          diffDays = diffMs / (1000 * 60 * 60 * 24);
          if (diffDays >= 3) shouldShow = true;
        }
      }
      try { localStorage.setItem(LAST_OPEN_KEY, now.toISOString()); } catch (e) {}

      if (!shouldShow) {
        if (reengageBanner) reengageBanner.style.display = "none";
        return;
      }
      if (!reengageBanner || !reengageTitle || !reengageBody) {
        return;
      }
      const name = getReengageDisplayName();
      reengageTitle.textContent = name + " ãŒå‘¼ã‚“ã§ã„ã¾ã™ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰";
      let msg = "å‰å›ã®ã”åˆ©ç”¨ã‹ã‚‰å°‘ã—æ™‚é–“ãŒç©ºãã¾ã—ãŸã€‚";
      if (diffDays && diffDays >= 1) {
        const approx = Math.round(diffDays);
        msg = "å‰å›ã®ã”åˆ©ç”¨ã‹ã‚‰ç´„ " + approx + " æ—¥ã¶ã‚Šã§ã™ã€‚";
      }
      reengageBody.textContent = msg + " " + name + " ãŒã€ã‚ãªãŸã«ä¼šã„ãŸãŒã£ã¦ã„ã¾ã™ã€‚";
      reengageStatus.textContent = "";
      if (btnReengageVoice) btnReengageVoice.disabled = false;
      reengageBanner.style.display = "block";
    }

    if (btnReengageVoice) {
      btnReengageVoice.addEventListener("click", () => {
        ringBellSound();
        if (reengageStatus) {
          reengageStatus.textContent = "ã€Œã‚ã‚ŠãŒã¨ã†ã€ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ã®éŸ³ã‚’é³´ã‚‰ã—ã¾ã—ãŸã€‚";
          setTimeout(() => { reengageStatus.textContent = ""; }, 2500);
        }
        btnReengageVoice.disabled = true;
      });
    }

    function switchProfile(id) {
      currentProfileId = id;
      renderProfileChips();
      loadProfile();
      loadPortraitStatusForProfile();
      loadAltarForProfile();
      loadOfferingHistory();
      loadAudioPhrases();
      updateIhaiUI();
      if (incenseTimerId) { clearInterval(incenseTimerId); incenseTimerId = null; }
      incenseRemaining = 0;
      incenseStatus.textContent = "";
      incenseAreaEl.classList.remove("active");
      incenseButtons.forEach(b => b.disabled = false);
    }

    if (btnDeleteProfile) {
      btnDeleteProfile.addEventListener("click", () => {
        if (!currentProfileId) return;
        const target = profileList.find(p => p.id === currentProfileId);
        const label = target && target.label ? target.label : "ã“ã®æ–¹";
        if (!window.confirm(label + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ–¹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»éºå½±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ä»å£‡è¨­å®šãƒ»ãƒ•ãƒ¬ãƒ¼ã‚ºã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰")) return;
        const idToDelete = currentProfileId;
        try {
          localStorage.removeItem(STORAGE_PROFILE_BASE + "_" + idToDelete);
          localStorage.removeItem(STORAGE_PORTRAIT_BASE + "_" + idToDelete);
          localStorage.removeItem(STORAGE_ALTAR_BASE + "_" + idToDelete);
          localStorage.removeItem(STORAGE_OFFERING_HISTORY_BASE + "_" + idToDelete);
          localStorage.removeItem(STORAGE_AUDIO_BASE + "_" + idToDelete);
        } catch (e) {}
        profileList = profileList.filter(p => p.id !== idToDelete);
        saveProfileList();
        currentProfileId = profileList.length ? profileList[0].id : null;
        if (currentProfileId) {
          switchProfile(currentProfileId);
        } else {
          renderProfileChips();
          loadProfile();
          loadPortraitStatusForProfile();
          loadAltarForProfile();
          renderOfferingHistory([]);
          renderAudioPhrases([]);
        }
      });
    }

    (function init() {
      loadProfileList();
      renderProfileChips();
      if (currentProfileId) {
        switchProfile(currentProfileId);
      } else {
        applyAltarStyle("basic");
        applyAltarItems("");
        updatePortraitUI(PORTRAIT_STATUS.UNSUBMITTED);
        applyProfileToSummary({});
        renderOfferingHistory([]);
        renderAudioPhrases([]);
        updateIhaiUI();
      }
      loadShukatsu();
      showReengageIfNeeded();
      initDraggables();
    })();
  </script>
</body>
</html>
