<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>デジタル仏壇 v9（遺影→仏壇→プロフィール）</title>
<style>
:root{--bg:#f6f6f6;--card:#fff;--accent:#c59d5f;--text:#222;--muted:#777}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans","Yu Gothic",Meiryo,sans-serif}
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid #eee;padding:10px 12px;z-index:20}
h1{margin:0;font-size:16px}
.nav{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:999px;border:1px solid #ddd;background:#fff;color:#333;cursor:pointer;font-weight:600}
.tab.active{border-color:var(--accent);background:#fff7e8}
.step{margin-left:auto;display:flex;gap:6px;align-items:center}
.btn{padding:9px 13px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
.btn-outline{background:#fff;color:var(--accent)}
.btn-ghost{background:#fff;border:1px solid #ddd;color:#333}
.container{max-width:1000px;margin:0 auto;padding:12px}
.page{display:none}
.page.active{display:block}
.note{color:#666;font-size:12px;margin:8px 0}
/* --- Portrait page --- */
.stage{position:relative;border:1px dashed #e8e0cf;border-radius:16px;overflow:hidden;background:#fcfbf8;min-height:520px}
.altar-bg{position:absolute;inset:0}.altar-bg img{width:100%;height:100%;object-fit:cover;opacity:.9;filter:saturate(.95)}
.portrait-wrap{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(78vw,360px);height:calc(min(78vw,360px)*1.25);display:grid;place-items:center;z-index:2}
.frame{position:relative;width:100%;height:100%;border:8px solid #d8c9a5;border-radius:14px;background:linear-gradient(#fefefe,#f7f3ea)}
.frame::after{content:"";position:absolute;inset:0;border:2px solid rgba(0,0,0,.06);border-radius:10px;pointer-events:none}
.portrait{position:absolute;inset:12px;border-radius:8px;background:#eee;overflow:hidden;display:grid;place-items:center}
.portrait img{width:100%;height:100%;object-fit:cover}.silhouette{width:50%;opacity:.35;filter:grayscale(100%)}
.status{position:absolute;left:12px;top:12px;background:#fff;padding:4px 10px;border-radius:999px;border:1px solid #eee;font-size:12px}
.badge{font-weight:800}.status.pending{background:#fff7e8;border-color:#f5d9a9}.status.approved{background:#e9f8ee;border-color:#bde5c8}
.overlay{position:absolute;inset:12px;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center;font-weight:700;color:#333;border-radius:8px}
.spinner{width:22px;height:22px;border:3px solid #bbb;border-top-color:#7a7a7a;border-radius:50%;animation:sp 1s linear infinite;margin-right:8px}@keyframes sp{to{transform:rotate(360deg)}}
.panel{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.admin{display:flex;gap:8px;align-items:center}.admin .btn{padding:7px 11px}.admin-tag{font-size:12px;color:#555;background:#fff;border:1px dashed #bbb;border-radius:999px;padding:4px 8px}
.sheetWrap{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
.sheet{width:100%;max-width:1000px;background:var(--card);border-top-left-radius:20px;border-top-right-radius:20px;padding:16px;box-shadow:0 -8px 24px rgba(0,0,0,.2)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}@media(min-width:720px){.grid{grid-template-columns:repeat(6,1fr)}}
.entry{border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff;cursor:pointer;text-align:center}.entry .thumb{height:100px;background:#f3f3f3}.entry .thumb img{width:100%;height:100%;object-fit:cover}.entry .name{padding:8px 6px;font-size:12px;font-weight:700}
.consents{margin:12px 0;display:grid;gap:8px}.consents label{display:flex;gap:8px;align-items:flex-start;font-size:14px}
.fileRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
/* --- Altar page (v7.2 features) --- */
.stage-wrap{margin-top:8px;border:1px dashed #e8e0cf;border-radius:16px;overflow:hidden;background:#fcfbf8}
.stage2{position:relative;min-height:600px;touch-action:none}
.canvas{position:relative;z-index:2;width:100%;height:100%}
.hint{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#777;font-size:13px;z-index:1;text-align:center}
.item{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);user-select:none;touch-action:none}
.item img{display:block;max-width:280px;max-height:280px;width:220px;height:auto;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
.item .label{position:absolute;left:50%;bottom:-20px;transform:translateX(-50%);font-size:12px;color:#333;background:rgba(255,255,255,.6);padding:2px 8px;border-radius:999px}
.item .handle{position:absolute;right:-10px;bottom:-10px;width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid var(--accent);display:grid;place-items:center;font-size:14px;color:var(--accent);cursor:nwse-resize}
.item.selected{outline:2px dashed var(--accent);outline-offset:4px}
.stack{position:absolute;right:8px;top:8px;display:flex;gap:6px;z-index:5}.stack .chip{padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fff;font-size:12px;cursor:pointer}.stack .chip[disabled]{opacity:.35;cursor:not-allowed}
.catalog-tabs{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}.chip{padding:8px 12px;border-radius:999px;border:1px solid #ddd;background:#fafafa;font-size:13px;cursor:pointer}.chip.active{border-color:var(--accent);background:#fff7e8}
.incense-layer{position:absolute;left:0;right:0;bottom:0;top:0;pointer-events:none;z-index:3}
.incense{position:absolute;width:8px;height:18px;background:linear-gradient(180deg,#6b4d2e,#3b2a18);border-radius:2px;box-shadow:0 2px 4px rgba(0,0,0,.2)}
.incense::after{content:"";position:absolute;left:50%;top:-6px;transform:translateX(-50%);width:6px;height:6px;background:radial-gradient(circle,#ffcf6d,#ff8a00);border-radius:50%;filter:blur(.3px)}
.smoke{position:absolute;left:50%;bottom:42px;width:12px;height:12px;border-radius:50%;background:rgba(180,180,180,.35);filter:blur(1px);animation:smoke 2.4s linear forwards}
@keyframes smoke{0%{transform:translate(-50%,0) scale(1);opacity:.45}60%{transform:translate(-50%,-70px) scale(1.3);opacity:.25}100%{transform:translate(-50%,-120px) scale(1.6);opacity:0}}
.timerTag{position:absolute;left:50%;bottom:0;transform:translate(-50%,8px);font-size:12px;background:rgba(255,255,255,.8);padding:2px 8px;border-radius:999px;border:1px solid #eee;color:#333}
.ihaiOverlay{position:absolute;inset:0;pointer-events:none}
.ihaiOverlay .kaimyo{position:absolute;top:12%;bottom:12%;left:50%;transform:translateX(-50%);writing-mode:vertical-rl;text-orientation:mixed;font-family:"Yu Mincho","Hiragino Mincho ProN","Noto Serif JP",serif;font-weight:600;letter-spacing:2px;line-height:1.45;color:#1d140b;text-shadow:0 1px 1px rgba(255,255,255,.4),0 1px 12px rgba(0,0,0,.15);font-size:22px;white-space:pre-wrap;text-align:center}
/* --- Profile page --- */
.form{display:grid;gap:10px;max-width:720px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.row label{width:100px;color:#444}
.row input,.row select,.row textarea{flex:1;min-width:200px;padding:8px 10px;border:1px solid #ddd;border-radius:10px}
.row textarea{min-height:140px}
.badge-ok{display:inline-block;padding:2px 8px;border-radius:999px;background:#e8f7ec;border:1px solid #bfe3c9;color:#205b2f;font-size:12px}
.preview{margin-top:8px;border:1px solid #eee;border-radius:12px;background:#fff;padding:12px}
</style>
</head>
<body>
<header>
  <h1>デジタル仏壇 v9</h1>
  <div class="nav">
    <button class="tab active" data-go="p1">① 遺影</button>
    <button class="tab" data-go="p2">② 仏壇</button>
    <button class="tab" data-go="p3">③ プロフィール</button>
    <div class="step">
      <button class="btn-ghost" id="prevBtn">← 前へ</button>
      <button class="btn" id="nextBtn">次へ →</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- Page 1: Portrait (A plan) -->
  <section id="p1" class="page active">
    <div class="stage">
      <div class="altar-bg"><img src="https://picsum.photos/seed/altarA/1600/1000" alt=""></div>
      <div class="portrait-wrap" aria-live="polite">
        <div class="frame">
          <div class="portrait" id="portrait"><img class="silhouette" id="silhouette" src="https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png" alt="シルエット"></div>
          <div class="overlay" id="overlay"><div class="spinner"></div>審査中...</div>
          <div class="status" id="status"><span class="badge">未申請</span> / アップロードして承認を待ちます</div>
        </div>
      </div>
    </div>
    <div class="panel" style="margin-top:8px">
      <button class="btn" id="btnApply">遺影を申請</button>
      <button class="btn-outline" id="btnSendToAltar" disabled>（承認後）仏壇に遺影を配置</button>
      <div class="admin">
        <span class="admin-tag">運営（擬似）</span>
        <button class="btn-outline" id="btnApprove" disabled>承認</button>
        <button class="btn-ghost" id="btnReject" disabled>却下</button>
      </div>
    </div>
    <p class="note">※ 擬似体験：申請→審査中→承認/却下。承認後は「仏壇に遺影を配置」で②ページに反映できます。</p>
  </section>

  <!-- Page 2: Altar (v7.2) -->
  <section id="p2" class="page">
    <div class="panel">
      <button class="btn" id="btnAltar">仏壇を選ぶ</button>
      <a class="btn btn-outline" id="btnBuy" href="#" target="_blank" rel="noopener" aria-disabled="true">仏壇を購入</a>
      <button class="btn btn-outline" id="btnCatalog">カタログ（仏具・お供え）</button>
      <button class="btn-ghost" id="btnEdit">編集モード：OFF</button>
      <button class="btn-outline" id="btnIhai" disabled>位牌テキスト編集</button>
      <button class="btn-outline" id="btnPlacePortrait" disabled>遺影を配置</button>
      <button class="btn" id="btnIncense15">線香（15秒）</button>
      <button class="btn" id="btnIncense30">線香（30秒）</button>
      <button class="btn" id="btnIncense60">線香（1分）</button>
      <button class="btn-outline" id="btnRing">鈴を鳴らす</button>
    </div>
    <div class="stage-wrap">
      <div class="stage2" id="stage2">
        <div class="altar-bg"><img id="altarBg" src="https://picsum.photos/seed/altarA/1600/1000" alt=""></div>
        <div class="canvas" id="canvas"></div>
        <div class="incense-layer" id="incenseLayer" aria-live="polite"></div>
        <div class="hint" id="hint">「カタログ」で仏具・お供えを配置。線香は香炉の位置から煙が上がります。</div>
        <div class="stack">
          <span class="chip" id="buySelected" disabled>購入ページ</span>
          <span class="chip" id="front">最前面へ</span>
          <span class="chip" id="back">最背面へ</span>
          <span class="chip" id="remove">削除</span>
        </div>
      </div>
    </div>
    <p class="note">※ 一括片付けは廃止。選択→「削除」で個別に取り除けます。鈴は常に鳴ります。</p>

    <!-- Sheets for page2 -->
    <div class="sheetWrap" id="sheetAltar"><div class="sheet"><h3 style="margin:0 0 8px">仏壇を選ぶ</h3><div class="grid" id="altarGrid"></div></div></div>
    <div class="sheetWrap" id="sheetCatalog"><div class="sheet">
      <div class="catalog-tabs" id="tabs">
        <button class="chip active" data-cat="main">本尊・掛け軸・位牌</button>
        <button class="chip" data-cat="vessels">供物・器類</button>
        <button class="chip" data-cat="bell">おりん・火立・香炉</button>
        <button class="chip" data-cat="tools">道具（マッチ消／線香差）</button>
        <button class="chip" data-cat="offering">お供え（花・果物・菓子・飲料・線香）</button>
      </div>
      <div class="grid" id="catalogGrid"></div>
    </div></div>

    <div class="sheetWrap" id="sheetIhai"><div class="sheet">
      <h3 style="margin:0 0 8px">位牌テキスト編集</h3>
      <div class="row"><label for="kaimyoInput">戒名・俗名（縦）</label><input id="kaimyoInput" type="text" placeholder="例：釋○○信士／信女 または 山田太郎"></div>
      <div class="row"><label for="kaimyoSize">文字サイズ</label><input id="kaimyoSize" type="range" min="16" max="36" value="22"></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn-ghost" id="btnIhaiClear">文字を消す</button>
        <button class="btn" id="btnIhaiApply">反映する</button>
        <button class="btn-outline" id="btnIhaiClose">閉じる</button>
      </div>
      <p class="note">※ 位牌を選択してから編集してください。</p>
    </div></div>
  </section>

  <!-- Page 3: Profile -->
  <section id="p3" class="page">
    <h3 style="margin:6px 0 10px">プロフィール（記録）</h3>
    <div class="form">
      <div class="row"><label for="dod">没年月日</label><input id="dod" type="date"></div>
      <div class="row"><label for="rel">続柄</label>
        <select id="rel">
          <option value="">選択してください</option>
          <option>祖父</option><option>祖母</option><option>父</option><option>母</option>
          <option>夫</option><option>妻</option><option>兄弟</option><option>姉妹</option>
          <option>息子</option><option>娘</option><option>親戚</option><option>友人</option><option>その他</option>
        </select>
      </div>
      <div class="row"><label for="memo">思い出</label><textarea id="memo" placeholder="例：よく一緒に釣りに行きました…"></textarea></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button class="btn-ghost" id="btnClearProfile">リセット</button>
        <button class="btn" id="btnSaveProfile">保存</button>
      </div>
    </div>
    <div class="preview" id="profilePreview" style="display:none"></div>
    <p class="note">※ 端末のローカル（localStorage）に保存します。後から編集できます。</p>
  </section>
</div>

<!-- Portrait Apply Sheet -->
<div class="sheetWrap" id="sheetApply">
  <div class="sheet">
    <h3 style="margin:0 0 12px">遺影の申請</h3>
    <p style="margin:0 0 8px;color:#444">どちらかを選んでください：</p>
    <div class="fileRow">
      <input type="file" id="fileInput" accept="image/*">
      <span style="font-size:12px;color:#666">※ 推奨比率 4:5／10MB以下</span>
    </div>
    <p style="margin:12px 0 6px;color:#444">サンプルから選ぶ（擬似用）</p>
    <div class="grid" id="sampleGrid"></div>
    <div class="consents">
      <label><input type="checkbox" id="c1">私はこの写真のアップロード・利用に必要な権限を有しています。</label>
      <label><input type="checkbox" id="c2">被写体（故人）に関わる関係者の同意を取得済みです。</label>
      <label><input type="checkbox" id="c3">著名人/第三者の無断利用、権利侵害画像ではありません。</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn-ghost" id="btnCancel">やめる</button>
      <button class="btn" id="btnSubmit" disabled>申請する</button>
    </div>
  </div>
</div>

<script>
(function(){
  // -------- Simple router ----------
  const pages=['p1','p2','p3'];
  const tabs=[...document.querySelectorAll('.tab')];
  const prevBtn=document.getElementById('prevBtn'), nextBtn=document.getElementById('nextBtn');
  function show(id){ pages.forEach(pid=>{document.getElementById(pid).classList.toggle('active', pid===id);}); tabs.forEach(t=>t.classList.toggle('active', t.dataset.go===id)); localStorage.setItem('v9_current', id); updateNav(id); if(id==='p2') onEnterAltar(); if(id==='p3') loadProfile(); }
  function updateNav(id){ const i=pages.indexOf(id); prevBtn.disabled=(i===0); nextBtn.disabled=(i===pages.length-1); }
  tabs.forEach(t=>t.onclick=()=>show(t.dataset.go));
  prevBtn.onclick=()=>{ const i=pages.indexOf(current()); if(i>0) show(pages[i-1]); };
  nextBtn.onclick=()=>{ const i=pages.indexOf(current()); if(i<pages.length-1) show(pages[i+1]); };
  function current(){ return pages.find(pid=>document.getElementById(pid).classList.contains('active')); }
  show(localStorage.getItem('v9_current')||'p1');

  // -------- v8 Portrait flow ----------
  const sheet = document.getElementById('sheetApply');
  const btnApply = document.getElementById('btnApply');
  const btnCancel = document.getElementById('btnCancel');
  const btnSubmit = document.getElementById('btnSubmit');
  const fileInput = document.getElementById('fileInput');
  const sampleGrid = document.getElementById('sampleGrid');
  const c1=document.getElementById('c1'), c2=document.getElementById('c2'), c3=document.getElementById('c3');
  const status = document.getElementById('status');
  const overlay = document.getElementById('overlay');
  const portrait = document.getElementById('portrait');
  const silhouette = document.getElementById('silhouette');
  const btnApprove = document.getElementById('btnApprove');
  const btnReject = document.getElementById('btnReject');
  const btnSendToAltar = document.getElementById('btnSendToAltar');

  let chosenURL = null, pending = false, approved = false;

  const SAMPLES = [
    'https://picsum.photos/seed/portraitA/600/750',
    'https://picsum.photos/seed/portraitB/600/750',
    'https://picsum.photos/seed/portraitC/600/750',
    'https://picsum.photos/seed/portraitD/600/750'
  ];
  function renderSamples(){
    sampleGrid.innerHTML='';
    SAMPLES.forEach((url,i)=>{
      const el=document.createElement('button'); el.className='entry';
      el.innerHTML='<div class="thumb"><img src="'+url+'" alt="サンプル'+(i+1)+'"></div><div class="name">サンプル'+(i+1)+'</div>';
      el.onclick=()=>{ chosenURL=url; updateSubmitButton(); highlightChoice(el); };
      sampleGrid.appendChild(el);
    });
  }
  function highlightChoice(el){ sampleGrid.querySelectorAll('.entry').forEach(e=>e.style.outline='none'); el.style.outline='2px solid var(--accent)'; }
  btnApply.onclick=()=>{ if(pending){ alert('現在、審査中です。承認/却下後に再申請してください。'); return; } chosenURL=null; fileInput.value=''; [c1,c2,c3].forEach(c=>c.checked=false); btnSubmit.disabled=true; renderSamples(); sheet.style.display='flex'; };
  btnCancel.onclick=()=> sheet.style.display='none';
  sheet.onclick=(e)=>{ if(e.target===sheet) sheet.style.display='none'; };
  fileInput.onchange=(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f){ chosenURL=null; updateSubmitButton(); return;} chosenURL=URL.createObjectURL(f); sampleGrid.querySelectorAll('.entry').forEach(e=>e.style.outline='none'); updateSubmitButton(); };
  [c1,c2,c3].forEach(cb=>cb.onchange=updateSubmitButton);
  function updateSubmitButton(){ btnSubmit.disabled=!(chosenURL && c1.checked && c2.checked && c3.checked); }
  btnSubmit.onclick=()=>{ if(btnSubmit.disabled) return; sheet.style.display='none'; pending=true; approved=false; overlay.style.display='flex'; status.classList.remove('approved'); status.classList.add('pending'); status.innerHTML='<span class="badge">審査中</span> / 運営の承認をお待ちください'; btnApprove.disabled=false; btnReject.disabled=false; };
  btnApprove.onclick=()=>{ if(!pending) return; applyPortrait(chosenURL); approved=true; pending=false; overlay.style.display='none'; status.classList.remove('pending'); status.classList.add('approved'); status.innerHTML='<span class="badge">承認済み</span> / 遺影を表示しています'; btnApprove.disabled=true; btnReject.disabled=true; btnSendToAltar.disabled=false; localStorage.setItem('v9_portrait_url', chosenURL); };
  btnReject.onclick=()=>{ if(!pending) return; chosenURL=null; approved=false; pending=false; overlay.style.display='none'; status.classList.remove('pending','approved'); status.innerHTML='<span class="badge">未申請</span> / アップロードして承認を待ちます'; clearPortrait(); btnApprove.disabled=true; btnReject.disabled=true; btnSendToAltar.disabled=true; localStorage.removeItem('v9_portrait_url'); };
  btnSendToAltar.onclick=()=>{ show('p2'); };

  function applyPortrait(url){ clearPortrait(); const img=document.createElement('img'); img.src=url; img.alt='承認済みの遺影'; portrait.appendChild(img); }
  function clearPortrait(){ portrait.innerHTML=''; portrait.appendChild(silhouette); }

  // -------- v7.2 Altar --------
  const ALTARS=[{id:'a',name:'仏壇A（明るめ木目）',img:'https://picsum.photos/seed/altarA/1600/1000',buy:'https://example.com/butsudanA'},
                {id:'b',name:'仏壇B（ダーク系）',img:'https://picsum.photos/seed/altarB/1600/1000',buy:'https://example.com/butsudanB'},
                {id:'c',name:'仏壇C（シンプル）',img:'https://picsum.photos/seed/altarC/1600/1000',buy:'https://example.com/butsudanC'},
                {id:'d',name:'仏壇D（金箔アクセント）',img:'https://picsum.photos/seed/altarD/1600/1000',buy:'https://example.com/butsudanD'}];
  const CATALOG={
    main:[
      {id:'gohonzon',name:'御本尊',img:'https://picsum.photos/seed/gohonzon/600/800'},
      {id:'kakejiku',name:'掛け軸',img:'https://picsum.photos/seed/kakejiku/600/800'},
      {id:'ihai-s',name:'位牌（小）',img:'https://picsum.photos/seed/ihaiS/400/600',kind:'ihai'},
      {id:'ihai-m',name:'位牌（中）',img:'https://picsum.photos/seed/ihaiM/500/750',kind:'ihai'},
      {id:'ihai-l',name:'位牌（大）',img:'https://picsum.photos/seed/ihaiL/600/900',kind:'ihai'}
    ],
    vessels:[
      {id:'buppanki',name:'仏飯器',img:'https://picsum.photos/seed/buppanki/800/600'},
      {id:'chayuuki',name:'茶湯器',img:'https://picsum.photos/seed/chayuuki/800/600'},
      {id:'hanadate',name:'花立',img:'https://picsum.photos/seed/hanadate/800/600'},
      {id:'takatsuki',name:'高月',img:'https://picsum.photos/seed/takatsuki/800/600'},
      {id:'buppanzen',name:'仏飯膳',img:'https://picsum.photos/seed/buppanzen/800/600'}
    ],
    bell:[
      {id:'orin',name:'おりん',img:'https://picsum.photos/seed/orin/800/600'},
      {id:'rinbo',name:'リン棒',img:'https://picsum.photos/seed/rinbo/800/600'},
      {id:'hidate',name:'火立',img:'https://picsum.photos/seed/hidate/800/600'},
      {id:'koro',name:'香炉',img:'https://picsum.photos/seed/koro/800/600'}
    ],
    tools:[
      {id:'matchkeshi',name:'マッチ消',img:'https://picsum.photos/seed/matchkeshi/800/600'},
      {id:'senkosashi-a',name:'線香差（A）',img:'https://picsum.photos/seed/senkosashiA/800/600'},
      {id:'senkosashi-b',name:'線香差（B）',img:'https://picsum.photos/seed/senkosashiB/800/600'},
      {id:'senkosashi-c',name:'線香差（C）',img:'https://picsum.photos/seed/senkosashiC/800/600'}
    ],
    offering:[
      {id:'flower-white',name:'仏花（白）',img:'https://picsum.photos/seed/flower1/600/600'},
      {id:'flower-color',name:'仏花（彩）',img:'https://picsum.photos/seed/flower2/600/600'},
      {id:'fruit-mikan',name:'みかん',img:'https://picsum.photos/seed/fruit1/600/600'},
      {id:'fruit-grape',name:'ぶどう',img:'https://picsum.photos/seed/fruit2/600/600'},
      {id:'fruit-apple',name:'りんご',img:'https://picsum.photos/seed/fruit3/600/600'},
      {id:'wagashi',name:'和菓子',img:'https://picsum.photos/seed/sweets1/600/600'},
      {id:'dango',name:'団子',img:'https://picsum.photos/seed/sweets2/600/600'},
      {id:'manju',name:'まんじゅう',img:'https://picsum.photos/seed/sweets3/600/600'},
      {id:'green-tea',name:'緑茶',img:'https://picsum.photos/seed/drink1/600/600'},
      {id:'bottle-juice',name:'ジュース（瓶）',img:'https://picsum.photos/seed/drink2/600/600'},
      {id:'can-coffee',name:'コーヒー缶',img:'https://picsum.photos/seed/drink3/600/600'},
      {id:'incense-bundle',name:'線香束',img:'https://picsum.photos/seed/insence1/600/600'},
      {id:'incense-set',name:'香皿セット',img:'https://picsum.photos/seed/insence2/600/600'},
      {id:'brand-monaka',name:'桜最中（コラボ）',img:'https://picsum.photos/seed/brandwagashi/600/600',url:'https://example.com/collab-monaka'},
      {id:'brand-juice',name:'瓶ジュース（コラボ）',img:'https://picsum.photos/seed/brandjuice/600/600',url:'https://example.com/collab-juice'},
      {id:'brand-cheesecake',name:'チーズケーキ（コラボ）',img:'https://picsum.photos/seed/brandcake/600/600',url:'https://example.com/collab-cheesecake'}
    ]
  };
  const stage2=document.getElementById('stage2'), canvas=document.getElementById('canvas'), incenseLayer=document.getElementById('incenseLayer'), hint=document.getElementById('hint');
  const btnAltar=document.getElementById('btnAltar'), sheetAltar=document.getElementById('sheetAltar'), altarGrid=document.getElementById('altarGrid'), altarBg=document.getElementById('altarBg'), btnBuy=document.getElementById('btnBuy');
  const btnCatalog=document.getElementById('btnCatalog'), sheetCatalog=document.getElementById('sheetCatalog'), catalogGrid=document.getElementById('catalogGrid'), tabs2=document.getElementById('tabs');
  const btnEdit=document.getElementById('btnEdit'), front=document.getElementById('front'), back=document.getElementById('back'), remove=document.getElementById('remove'), buySelected=document.getElementById('buySelected');
  const btnIncense15=document.getElementById('btnIncense15'), btnIncense30=document.getElementById('btnIncense30'), btnIncense60=document.getElementById('btnIncense60'), btnRing=document.getElementById('btnRing');
  const btnIhai=document.getElementById('btnIhai'), sheetIhai=document.getElementById('sheetIhai'), kaimyoInput=document.getElementById('kaimyoInput'), kaimyoSize=document.getElementById('kaimyoSize'), btnIhaiApply=document.getElementById('btnIhaiApply'), btnIhaiClose=document.getElementById('btnIhaiClose'), btnIhaiClear=document.getElementById('btnIhaiClear');
  const btnPlacePortrait=document.getElementById('btnPlacePortrait');
  let editMode=false, selected=null, zCounter=10, currentCat='main';

  btnAltar.onclick=()=>{ sheetAltar.style.display='flex'; renderAltars(); };
  sheetAltar.onclick=(e)=>{ if(e.target===sheetAltar) sheetAltar.style.display='none'; };
  function renderAltars(){ altarGrid.innerHTML=''; ALTARS.forEach(a=>{ const el=document.createElement('button'); el.className='entry'; el.innerHTML=`<div class="thumb"><img src="${a.img}" alt="${a.name}"></div><div class="name">${a.name}</div>`; el.onclick=()=>{altarBg.src=a.img;btnBuy.href=a.buy;btnBuy.setAttribute('aria-disabled','false');sheetAltar.style.display='none';}; altarGrid.appendChild(el); }); }

  btnCatalog.onclick=()=>{ sheetCatalog.style.display='flex'; renderCatalog(); };
  sheetCatalog.onclick=(e)=>{ if(e.target===sheetCatalog) sheetCatalog.style.display='none'; };
  tabs2.onclick=(e)=>{ if(e.target.matches('.chip')){ tabs2.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); e.target.classList.add('active'); currentCat=e.target.dataset.cat; renderCatalog(); } };
  function renderCatalog(){ catalogGrid.innerHTML=''; (CATALOG[currentCat]||[]).forEach(item=>{ const el=document.createElement('button'); el.className='entry'; el.innerHTML=`<div class="thumb"><img src="${item.img}" alt="${item.name}"></div><div class="name">${item.name}</div><div class="type">${item.url?'購入ページあり':'タップで追加'}</div>`; el.onclick=()=>{ addItem(item); if(currentCat==='offering'){ currentCat='main'; tabs2.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); tabs2.querySelector('[data-cat="main"]').classList.add('active'); renderCatalog(); } sheetCatalog.style.display='none'; }; catalogGrid.appendChild(el); }); }

  function addItem(data){ hint.style.display='none'; const el=document.createElement('div'); el.className='item'; el.style.zIndex=(++zCounter); el.dataset.url=data.url||''; el.dataset.kind=data.kind||''; el.dataset.id=data.id||''; el.innerHTML=`<img src="${data.img}" alt="${data.name}"><div class="label">${data.name}</div><div class="handle">↘</div>`; if(el.dataset.kind==='ihai'){ const overlay=document.createElement('div'); overlay.className='ihaiOverlay'; overlay.innerHTML='<div class="kaimyo"></div>'; el.appendChild(overlay); } canvas.appendChild(el); makeInteractive(el); select(el); }

  btnEdit.onclick=()=>{ editMode=!editMode; btnEdit.textContent='編集モード：'+(editMode?'ON':'OFF'); canvas.querySelectorAll('.item .handle').forEach(h=>h.style.display=editMode?'grid':'none'); };
  canvas.addEventListener('pointerdown', (e)=>{ if(e.target===canvas){ select(null); } });

  front.onclick=()=>{ if(selected) selected.style.zIndex=(++zCounter); };
  back.onclick=()=>{ if(selected) selected.style.zIndex='1'; };
  remove.onclick=()=>{ if(selected){ selected.remove(); setSelected(null); } };
  buySelected.onclick=()=>{ if(!selected) return; const url=selected.dataset.url; if(url) window.open(url, '_blank'); };

  function setBuyChip(el){ const url=el&&el.dataset?el.dataset.url:''; url?buySelected.removeAttribute('disabled'):buySelected.setAttribute('disabled',''); }
  function makeInteractive(el){
    const img=el.querySelector('img'), handle=el.querySelector('.handle'); handle.style.display=editMode?'grid':'none';
    let dragging=false,startX=0,startY=0,baseLeft=0,baseTop=0;
    el.addEventListener('pointerdown', (e)=>{ if(!editMode){ select(el); return; } if(e.target===handle) return; dragging=true; el.setPointerCapture(e.pointerId); startX=e.clientX; startY=e.clientY; const rect=el.getBoundingClientRect(), parent=canvas.getBoundingClientRect(); baseLeft=rect.left-parent.left; baseTop=rect.top-parent.top; select(el); e.preventDefault(); });
    el.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dx=e.clientX-startX,dy=e.clientY-startY; el.style.left=(baseLeft+dx)+'px'; el.style.top=(baseTop+dy)+'px'; el.style.transform='translate(0,0)'; });
    el.addEventListener('pointerup', ()=> dragging=false ); el.addEventListener('pointercancel', ()=> dragging=false );
    let resizing=false,startW=0,startH=0,rStartX=0,rStartY=0;
    handle.addEventListener('pointerdown', (e)=>{ if(!editMode) return; resizing=true; handle.setPointerCapture(e.pointerId); rStartX=e.clientX; rStartY=e.clientY; const rect=img.getBoundingClientRect(); startW=rect.width; startH=rect.height; select(el); e.preventDefault(); e.stopPropagation(); });
    handle.addEventListener('pointermove', (e)=>{ if(!resizing) return; const dx=e.clientX-rStartX,ratio=startW/startH; let newW=Math.max(80,startW+dx); img.style.width=newW+'px'; img.style.height=(newW/ratio)+'px'; });
    handle.addEventListener('pointerup', ()=> resizing=false ); handle.addEventListener('pointercancel', ()=> resizing=false );
    el.addEventListener('click', ()=> select(el) );
  }
  function setSelected(el){ selected=el; setBuyChip(el); if(el && el.dataset.kind==='ihai'){ btnIhai.removeAttribute('disabled'); } else { btnIhai.setAttribute('disabled',''); } }
  function select(el){ canvas.querySelectorAll('.item').forEach(i=>i.classList.remove('selected')); if(el) el.classList.add('selected'); setSelected(el); }

  // Incense from koro
  function lightIncense(seconds){
    const koro=(selected&&selected.dataset.id==='koro')?selected:canvas.querySelector('.item[data-id="koro"]');
    const holder=document.createElement('div'); holder.className='incense';
    const stageRect=stage2.getBoundingClientRect();
    if(koro){ const r=koro.getBoundingClientRect(); const cx=r.left+r.width/2-stageRect.left; const top=r.top-stageRect.top+r.height*0.05; holder.style.left=cx+'px'; holder.style.top=top+'px'; }
    else{ holder.style.left='50%'; holder.style.bottom='28px'; holder.style.transform='translateX(-50%)'; }
    incenseLayer.appendChild(holder);
    const tag=document.createElement('div'); tag.className='timerTag'; tag.textContent=seconds+'秒'; holder.appendChild(tag);
    const smokeInterval=setInterval(()=>{ const s=document.createElement('div'); s.className='smoke'; const drift=(Math.random()*36-18); s.style.transform='translate('+drift+'px,0)'; holder.appendChild(s); setTimeout(()=>s.remove(),2500); },550);
    let remain=seconds; const tick=setInterval(()=>{ remain-=1; if(remain>=0) tag.textContent=remain+'秒'; },1000);
    setTimeout(()=>{ clearInterval(smokeInterval); clearInterval(tick); holder.style.transition='opacity .6s'; holder.style.opacity='0'; setTimeout(()=>holder.remove(),650); }, seconds*1000);
  }
  document.getElementById('btnIncense15').onclick=()=>lightIncense(15);
  document.getElementById('btnIncense30').onclick=()=>lightIncense(30);
  document.getElementById('btnIncense60').onclick=()=>lightIncense(60);

  // Bell
  let audioCtx=null; function getCtx(){ if(!audioCtx||audioCtx.state==='closed'){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } return audioCtx; }
  document.getElementById('btnRing').onclick=async()=>{ const ctx=getCtx(); if(ctx.state==='suspended'){ try{ await ctx.resume(); }catch(e){} } ringBell(ctx); };
  function ringBell(ctx){ const now=ctx.currentTime, freqs=[740,1480,2220,2960], gains=[.8,.35,.18,.12]; freqs.forEach((f,i)=>{ const osc=ctx.createOscillator(), gain=ctx.createGain(); osc.type='sine'; osc.frequency.value=f; gain.gain.setValueAtTime(.0001,now); gain.gain.exponentialRampToValueAtTime(gains[i],now+.01); gain.gain.exponentialRampToValueAtTime(.0001,now+2.2+i*.1); osc.connect(gain).connect(ctx.destination); osc.frequency.exponentialRampToValueAtTime(f*.998,now+.2); osc.frequency.exponentialRampToValueAtTime(f*1.002,now+.6); osc.start(now); osc.stop(now+2.6+i*.1); }); }

  // Ihai editor (vertical only)
  btnIhai.onclick=()=>{ if(!selected||selected.dataset.kind!=='ihai')return; const k=selected.querySelector('.kaimyo')?.textContent||''; const kSize=parseInt(selected.querySelector('.kaimyo')?.style.fontSize||'22',10); document.getElementById('kaimyoInput').value=k; document.getElementById('kaimyoSize').value=isNaN(kSize)?22:kSize; document.getElementById('sheetIhai').style.display='flex'; };
  document.getElementById('sheetIhai').onclick=(e)=>{ if(e.target.id==='sheetIhai') e.currentTarget.style.display='none'; };
  btnIhaiClose.onclick=()=> document.getElementById('sheetIhai').style.display='none';
  btnIhaiClear.onclick=()=> document.getElementById('kaimyoInput').value='';
  btnIhaiApply.onclick=()=>{ if(!selected||selected.dataset.kind!=='ihai')return; const k=(document.getElementById('kaimyoInput').value||'').trim(); const kEl=selected.querySelector('.kaimyo'); kEl.textContent=k; kEl.style.fontSize=(parseInt(document.getElementById('kaimyoSize').value,10)||22)+'px'; document.getElementById('sheetIhai').style.display='none'; };

  // Place portrait into altar
  function onEnterAltar(){ const url=localStorage.getItem('v9_portrait_url'); btnPlacePortrait.disabled=!url; }
  btnPlacePortrait.onclick=()=>{ const url=localStorage.getItem('v9_portrait_url'); if(!url) return; addItem({id:'portrait',name:'遺影',img:url}); };

  // Init altar buy link
  btnBuy.href=ALTARS[0].buy; btnBuy.setAttribute('aria-disabled','false');

  // -------- Profile (page3) --------
  const dod=document.getElementById('dod'), rel=document.getElementById('rel'), memo=document.getElementById('memo'), preview=document.getElementById('profilePreview');
  function loadProfile(){ const data=JSON.parse(localStorage.getItem('v9_profile')||'{}'); dod.value=data.dod||''; rel.value=data.rel||''; memo.value=data.memo||''; renderPreview(); }
  function renderPreview(){ if(!dod.value && !rel.value && !memo.value){ preview.style.display='none'; preview.innerHTML=''; return;} preview.style.display='block'; preview.innerHTML=`<div class="badge-ok">保存済み</div><div style="margin-top:6px"><strong>没年月日：</strong>${dod.value||'-'}</div><div><strong>続柄：</strong>${rel.value||'-'}</div><div><strong>思い出：</strong><div style="white-space:pre-wrap">${(memo.value||'').replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</div></div>`; }
  document.getElementById('btnSaveProfile').onclick=()=>{ const data={dod:dod.value, rel:rel.value, memo:memo.value}; localStorage.setItem('v9_profile', JSON.stringify(data)); renderPreview(); };
  document.getElementById('btnClearProfile').onclick=()=>{ dod.value=''; rel.value=''; memo.value=''; localStorage.removeItem('v9_profile'); renderPreview(); };
})();
</script>
</body>
</html>
